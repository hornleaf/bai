#!/usr/bin/env bash
# shellcheck shell=bash disable=1102,2068,2145,2104,2199,1105

# =======================================================
# set -x  # è°ƒè¯•è¾“å‡º
# set -o  # å‘ç”Ÿé”™è¯¯æ—¶ç«‹å³é€€å‡º
set -o emacs # æ˜¾å¼å¯ç”¨ Emacs æ¨¡å¼

# =======================================================
# çµæ„Ÿæ¥è‡ª https://github.com/worthable/openai-terminal-assistant
# è¯¥é¡¹ç›®ä½¿ç”¨ curl å’Œ jq ç®€å•è°ƒç”¨å’Œæ’å…¥æ–‡ä»¶è°ƒç”¨ OpenAI API è¿›è¡Œä¸€æ¬¡å¯¹è¯
# åŸºäºæ­¤çµæ„Ÿæœ¬è„šæœ¬å»¶ç”Ÿå‡ºå¤šè½®å¯¹è¯ã€æµå¼å¤„ç†ã€å¾®è°ƒåˆ†æã€å‘½ä»¤æ‰§è¡Œç­‰æ–¹æ³•

# =======================================================
# ç°åŠ å…¥ ConEmu è¿›åº¦æŒ‡ç¤ºç‰¹æ€§ (OSC åºåˆ—)
# å‚è€ƒ https://learn.microsoft.com/zh-cn/windows/terminal/tutorials/progress-bar-sequences
# æŒ‡ç¤ºåºåˆ—ï¼š<OSC>9;4;<çŠ¶æ€>;<è¿›åº¦:å¯é€‰,0-100><å“é“ƒåºåˆ—>
# <çŠ¶æ€> æœ‰äº”ä¸ªçŠ¶æ€å€¼ï¼š
#   #1: é»˜è®¤çŠ¶æ€ï¼Œæ¸…é™¤è¿›åº¦æŒ‡ç¤º
#   #2: å°†è¿›åº¦è®¾ç½®ä¸º <è¿›åº¦>ï¼Œå¤„äºâ€œé»˜è®¤â€çŠ¶æ€
#   #3: è¡Œä¸ºåŒ #2, ä½†çŠ¶æ€å¤„äºâ€œé”™è¯¯â€
#   #4: å°†è¿›åº¦çŠ¶æ€è®¾ç½®ä¸º â€œä¸ç¡®å®šâ€ï¼Œæ­¤æ—¶å°†å¿½ç•¥ <è¿›åº¦>

# =======================================================
# Bash è¿æ¥æ›´æ–° ( 5.2.37 ~ 5.3.0 )ï¼ŒBai å°†ç§¯æä½¿ç”¨æ–°çš„è„šæœ¬ç‰¹æ€§
# æ–°çš„å‘½ä»¤æ›¿æ¢
#   * ${ command; }   # æ— éœ€åˆ›å»ºå­è¿›ç¨‹ï¼Œå³å¯è·å–å‘½ä»¤è¾“å‡º
#   * ${| command; }  # ç›´æ¥åœ¨å½“å‰ Shell ä¸­æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å°†ç»“æœå­˜å…¥å˜é‡ REPLY
# å†…å»ºå‘½ä»¤å¢å¼º
#   * read     # æ–°å¢é€‰é¡¹ `-E`ï¼Œåœ¨ `-e` çš„åŸºç¡€ä¸Šå¢å¼ºäº†è¡¥å…¨åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨å½“å‰ Shell å·²åŠ è½½çš„è¡¥å…¨å‡½æ•°
#   * source   # æ–°å¢é€‰é¡¹ `-p <PATH>`ï¼Œè¯¥é€‰é¡¹å°†åœ¨æŒ‡å®šçš„ä¸€ç»„ PATH è·¯å¾„ä¸­å¯»æ‰¾æ–‡ä»¶åå¹¶æ‰§è¡Œï¼Œä¾‹ï¼š
#       source -p dir/to/path:home/user example
# æ›´å¤šæ›´æ–°å†…å®¹å‚è§ https://tiswww.case.edu/php/chet/bash/NEWS

# =======================================================
# ä¸€äº›æ‰©å±•æ€§æ”¯æŒ
# å¯¹äº BAI å†…ç½®å‡½æ•°çš„é¢å¤–æ³¨é‡Šï¼Œä»¥æœŸé€šè¿‡ bash-language-server æä¾›æ›´å¥½çš„è¡¥å…¨å’Œæç¤º
# å¯¹äº BAI ä¼šè¯çš„æŒ‡ä»¤è¡¥å…¨ï¼Œæ­¤ä¸º Bash 5.3x æ–°å¢ç‰¹æ€§ï¼Œå‚è€ƒä¸Šè¿°æè¿°ï¼Œæ­¤åŠŸèƒ½ä»¥æœŸæä¾›æ›´å¥½çš„ä½¿ç”¨ä½“éªŒ
# å¯¹äºå‘½ä»¤è¡Œå‚æ•°è¡¥å…¨åŠŸèƒ½ï¼Œå°†æä¾›è¾ƒä¸ºçµæ´»çš„è¡¥å…¨æ–¹å¼ï¼Œä»¥æœŸæä¾›æ›´å¥½çš„å‘½ä»¤è¡Œä½¿ç”¨ä½“éªŒ


# å¯¹äºéä¸­å›½åŒºåŸŸè¯­è¨€çš„ä¸é€‚ç”¨è­¦å‘Š
[[ "${LANG:-C.UTF-8}" =~ ^zh_(CN|HK|TW).+$ ]] || echo 'WARNING: Non Chinese regions may not function properly.' >&2

# å¯¹äºæœªè·Ÿè¿›æœ€æ–°çš„ Bash çš„ä¸é€‚ç”¨è­¦å‘Šå’Œéƒ¨åˆ†å‘ä¸‹å…¼å®¹
BASH_LATEST_VERSION=5.3
if [[ "$BASH_VERSION" =~ ^"$BASH_LATEST_VERSION" ]];then
  complete -r;local_complete=true
  read_e_option=-E
else
  echo -e "WARNING: é Bash ${BASH_LATEST_VERSION}x ç‰ˆæœ¬å¯èƒ½å¯¼è‡´æ— æ³•æ­£å¸¸è¿è¡Œ" >&2
  local_complete=false
  read_e_option=-e
fi

# æ‹¦æˆªè„šæœ¬å†…å®¹æ‰§è¡Œ
[[ "$0" == "$BASH" ]] && echo "ERROR: ä¸å…è®¸ä»¥å‘½ä»¤æ–¹å¼æ‰§è¡Œè„šæœ¬å†…å®¹" && return

BAI_OS_TYPE=$(uname)
# BAI_OS_TYPE=unknown     # test
case ${BAI_OS_TYPE,,} in
  linux*):;;              # pass
  darwin*)OSE="MacOS X";; # MacOS
  msys*)OSE="WindowsNT (MSYS2)";;
  *)OSE="$BAI_OS_TYPE (æœªçŸ¥)";; 
esac
[ -n "$OSE" ] && echo "WARNING: æ‰€åœ¨ç³»ç»Ÿ \"$OSE\" æœªç»æµ‹è¯•é€‚é…ï¼Œæ‚¨å¯ç»§ç»­ä½¿ç”¨ä½†å»ºè®®åœ¨ Linux ä¸­ä½¿ç”¨æœ¬é¡¹ç›®" >&2

########################################################################
# é¢œè‰²
########################################################################

c0='\e[0m' c4='\e[4m' c31='\e[31m' c32='\e[32m' c33='\e[33m' c34='\e[34m'
c35='\e[35m' c36='\e[36m' h25='\e[?25h' l25='\e[?25l' ek='\e[K'
nocolor_command="exec &> >(sed -r \"s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[m|K]//g;s/\x1B]8;;(.*?)\x07(.*?)\x1B]8;;\x07/\2/g\")"
case "${BAI_COLOR:-auto}" in
  auto) [ ! -t 1 ] && eval "$nocolor_command";;
  always):;;
  never) eval "$nocolor_command";;
  *) exec echo "æœªçŸ¥çš„é¢œè‰²è®¾ç½®: $BAI_COLOR" >&2;;
esac
########################################################################
# å‡½æ•°
########################################################################

# è®¡æ—¶å™¨ æ¯«ç§’ï¼ˆmsï¼‰
# ç”¨æ³•: Get-Timer
# è¡Œä¸ºæ§åˆ¶:
#       å˜é‡ timer_start, timer_end, Get_Timer
#       è®¡æ—¶å™¨å¼€å§‹æ—¶ï¼ˆç¬¬ä¸€æ¬¡è°ƒç”¨ï¼‰ï¼Œå°†å˜é‡ timer_start è®¾ç½®ä¸ºå½“å‰æ—¶é—´
#       è®¡æ—¶å™¨ç»“æŸæ—¶ï¼ˆç¬¬äºŒæ¬¡è°ƒç”¨ï¼‰ï¼Œå°†å˜é‡ timer_end è®¾ç½®ä¸ºå½“å‰æ—¶é—´
#       ç¬¬äºŒæ¬¡è°ƒç”¨ç»“æŸæ—¶å°†ç»“æœå­˜å‚¨åœ¨å˜é‡ Get_Timer ä¸­ï¼Œå¹¶é‡ç½®å˜é‡ timer_start å’Œ timer_endï¼Œä¸‹ä¸€æ¬¡å°†é‡æ–°å¼€å§‹è®¡æ—¶
Get-Timer(){
  local date="date +%s%3N"
  local keys=("${1:-timer}_start" "${1:-timer}_end" "Get_${1:-}Timer")
  if ! [ "${!keys[0]}" ];then
    unset -v "${keys[2]}"
    builtin printf -v ${keys[0]} "$($date)"
  else
    builtin printf -v ${keys[1]} "$($date)"
    builtin printf -v ${keys[2]} "$((${!keys[1]} - ${!keys[0]}))"
    builtin printf -v ${keys[2]} "%'d ms" ${!keys[2]}
    unset -v "${keys[0]}" "${keys[1]}"
  fi
}
# è„šæœ¬åˆå§‹åŒ–è®¡æ—¶
Get-Timer

########################################################################

# é€å­—è¾“å‡º
# ç”¨æ³•: Print-FakeStream
# ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–æ–‡æœ¬ï¼Œå¹¶é€å­—æ‰“å°è‡³å½“å‰ç»ˆç«¯
Print-FakeStream(){
  local WITH=""
  local _msg=
  local _stdin="$(cat -)"
  local _stdin_num="${#_stdin}"
  while IFS= read -r LINE;do
    local STR="$LINE"
    local LEN=${#STR}
    for ((i=0;i<LEN;i++));do
      _msg="${STR:i:1}"
      WITH+="$_msg"
      echo -n "$_msg"
      Set-Osc-Progress info "${#WITH}:${_stdin_num}"
      sleep 0.001
    done
    echo
  done <<< "$_stdin"
  Set-Osc-Progress clear
}

########################################################################

# Bai ä¼šè¯å¸®åŠ©
# ç”¨æ³•: Get-Session-Help
# æ˜¾ç¤ºä¼šè¯å¸®åŠ©
Get-Session-Help(){
  local CHAT_HRLP_ALL=(
  '.help <æŒ‡ä»¤>?                    æ˜¾ç¤ºæŒ‡ä»¤å¸®åŠ©'
  '.exit <çŠ¶æ€ç >?                  é€€å‡ºå½“å‰ä¼šè¯'
  '.clear                           æ¸…ç©ºæ‰€æœ‰å¯¹è¯'
  '.copy cat? <ç´¢å¼•>?               ä»æœ€æ–°çš„å¯¹è¯ä¸­å¤åˆ¶ä»£ç å—'
  '.pass                            ç©ºæ“ä½œï¼Œç­‰ä»·äºç›´æ¥å›è½¦'
  '.files <æ–‡ä»¶>                    å‘æœåŠ¡æä¾›å•†ä¸Šä¼ å¾®è°ƒæ–‡ä»¶'
  '.file <æ–‡ä»¶>                     å‘å½“å‰å¯¹è¯æäº¤æ–‡ä»¶'
  '.run <å‘½ä»¤>                      æ‰§è¡Œ Shell å‘½ä»¤'
  '.eval <æç¤ºè¯>                   å°è¯•è®©å¤§æ¨¡å‹ç”Ÿæˆå‘½ä»¤'
  '.set <é…ç½®é¡¹>? <å€¼>?             å¯¹å½“å‰ä¼šè¯å±æ€§è¿›è¡Œè®¾ç½®'
  '.record <æ–‡ä»¶> <æ“ä½œ> [è¡Œä¸º]?    è®°å½•ç®¡ç†'
  '.cls                             æ¸…é™¤å±å¹•ï¼Œæˆ– .run clear'
  '.list                            åˆ—å‡ºæ‰€æœ‰å¯¹è¯è®°å½•'
  )

  declare -A CHAT_HRLP_MSG=(
      ['help']="ç”¨æ³•: .help [æŒ‡ä»¤]?\n  æ˜¾ç¤ºæŒ‡ä»¤çš„å¸®åŠ©ä¿¡æ¯ï¼Œè‹¥æœªæŒ‡å®šæŒ‡ä»¤ï¼Œåˆ™æ˜¾ç¤ºæ‰€æœ‰æŒ‡ä»¤çš„ç®€çŸ­å¸®åŠ©ä¿¡æ¯å’ŒæŒ‰é”®æè¿°"
      ['exit']="ç”¨æ³•: .exit [çŠ¶æ€ç ]?\n  é€€å‡ºå½“å‰ä¼šè¯, å¦‚æœæœªæŒ‡å®šçŠ¶æ€ç , åˆ™é»˜è®¤é€€å‡ºçŠ¶æ€ç ä¸º 0"
     ['clear']="æ¸…ç©ºå½“å‰æ‰€æœ‰å¯¹è¯è®°å½•, å¹¶é‡ç½®å¯¹è¯è½®æ¬¡"
      ['copy']="ç”¨æ³•: .copy cat? <ç´¢å¼•>?\n  ä»æœ€æ–°ä¸€è½®çš„å¯¹è¯ä¸­å¤åˆ¶ä»£ç å—\n  æœªæŒ‡å®š <ç´¢å¼•> æ—¶ï¼Œå°†æç¤ºå¯å¤åˆ¶çš„ä»£ç å—æ•°é‡\n  è‹¥æŒ‡å®šäº† <ç´¢å¼•>ï¼Œåˆ™ä¼šå¤åˆ¶æŒ‡å®šç´¢å¼•çš„ä»£ç å—\n  è‹¥æŒ‡å®šäº† cat è¡Œä¸ºï¼Œåˆ™ä¼šæ˜¾ç¤ºä½†ä¸å¤åˆ¶æŒ‡å®šç´¢å¼•çš„ä»£ç å—å†…å®¹"
      ['pass']="ç©ºæ“ä½œï¼Œæ‰§è¡Œåä¸ä¼šå‘ç”Ÿä»»ä½•äº‹"
     ['files']="ç”¨æ³•: .files [æ“ä½œ] <æ–‡ä»¶>|<æ–‡ä»¶ID>\n  åœ¨æœåŠ¡å•†çš„çŸ¥è¯†åº“ç®¡ç†ä¸´æ—¶æ–‡ä»¶\n  æ“ä½œ:\n   list - åˆ—å‡ºçŸ¥è¯†åº“é‡Œçš„æ–‡ä»¶\n   push - ä¸Šä¼ æ–‡ä»¶åˆ°çŸ¥è¯†åº“, <æ–‡ä»¶>\n   rm   - åˆ é™¤çŸ¥è¯†åº“ä¸­çš„æ–‡ä»¶, <æ–‡ä»¶ID>"
      ['file']="ç”¨æ³•: .file <æ–‡ä»¶>\n  å‘å½“å‰å¯¹è¯æäº¤æˆ–è¦†ç›–ä¸Šä¸€æ¬¡æäº¤çš„æ–‡ä»¶"
       ['run']="ç”¨æ³•: .run <å‘½ä»¤>\n  ä»¥ Bash æ‰§è¡Œ Shell å‘½ä»¤\n  é…ç½®é¡¹ local-execute = true æ—¶ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰å°†å…±äº« BAI çš„å†…éƒ¨ Shell ç¯å¢ƒ, å¦åˆ™å°†åœ¨éš”ç¦»çš„å­è¿›ç¨‹ä¸­æ‰§è¡Œ"
      ['eval']="ç”¨æ³•: .eval <æç¤ºè¯>\n  å°è¯•è®©å¤§æ¨¡å‹ç”Ÿæˆå‘½ä»¤å¹¶æ‰§è¡Œ\n  é…ç½®é¡¹ eval-skipask = true æ—¶ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰ï¼Œå°†ç›´æ¥æ‰§è¡Œç”Ÿæˆçš„å‘½ä»¤ï¼Œä¸æç¤ºç¡®è®¤"
       ['set']="ç”¨æ³•: .set <é…ç½®é¡¹>? <å€¼>?\n  å¯¹å½“å‰ä¼šè¯å±æ€§è¿›è¡Œè®¾ç½®, æ‰€æœ‰å‚æ•°å‡æœªæŒ‡å®šæ—¶ï¼Œå°†ä»¥å¯ä¾›é˜…è¯»çš„å½¢å¼åˆ—å‡ºæ‰€æœ‰é…ç½®é¡¹å’Œå…¶å€¼ã€æè¿°\n  è‹¥æŒ‡å®šäº† <é…ç½®é¡¹>ï¼Œåˆ™ä¼šæ˜¾ç¤ºæŒ‡å®šé…ç½®é¡¹çš„å€¼ï¼Œè‹¥æŒ‡å®šäº†<é…ç½®é¡¹> å’Œ <å€¼>ï¼Œåˆ™ä¼šè®¾ç½®æŒ‡å®šé…ç½®é¡¹çš„å€¼"
    ['record']="ç”¨æ³•: .record <æ–‡ä»¶> <æ“ä½œ> [è¡Œä¸º]?\n  å¯¼å…¥æˆ–å¯¼å‡ºå½“å‰å¯¹è¯è®°å½•ï¼ˆä¸åŒ…å«æŒ‡ä»¤æ‰§è¡Œï¼‰\n  æ“ä½œ:\n    import - å¯¼å…¥å¯¹è¯è®°å½•, import <æ–‡ä»¶>\n    export - å¯¼å‡ºå¯¹è¯è®°å½•, <æ–‡ä»¶> export [è¡Œä¸º]\n  è¡Œä¸º:\n    @no:tool  - ä¸åŒ…å«å·¥å…·è°ƒç”¨è®°å½•\n    @no:system - ä¸åŒ…å«ç³»ç»Ÿæç¤ºè®°å½•\n    @use:all  - å¯¼å‡ºæ‰€æœ‰è®°å½•, åŒ…æ‹¬æ•æ„Ÿä¿¡æ¯: API è·¯å¾„ã€API å¯†é’¥ã€æ¨¡å‹\n    @default  - é»˜è®¤å¯¼å‡ºè¡Œä¸ºï¼Œå¯¼å‡ºæ‰€æœ‰å¯¹è¯ï¼ŒåŒ…æ‹¬å·¥å…·è°ƒç”¨ä¿¡æ¯\n  æ³¨æ„: @use:all å¯¼å‡ºè¡Œä¸ºæ— å®Œå…¨å¯¼å…¥å…¼å®¹ï¼Œå¯¼å…¥æ—¶ä»…ä½¿ç”¨å¯¹è¯è®°å½•"
       ['cls']="æ¸…é™¤å±å¹•ï¼Œè¡Œä¸ºç­‰ä»·äº .run clear"
      ['list']="åˆ—å‡ºæ‰€æœ‰å¯¹è¯è®°å½•"
  )

  local CHAT_KEYS_ALL=(
  'Ctrl C/D'    'é€€å‡ºå½“å‰ä¼šè¯'
  'Ctrl L'      'æ¸…é™¤å±å¹• (run command: clear)'
  'Ctrl R'      'æœç´¢å†å²è¾“å…¥è®°å½• (å¦‚æœå®‰è£…äº† fzf å¹¶ä¸”æœªç¦ç”¨ï¼Œåˆ™ä½¿ç”¨ fzf æœç´¢)'
  'Ctrl G'      'å–æ¶ˆæœç´¢ (æœªæ›¿æ¢, Bash é»˜è®¤è¡Œä¸º)'
  'Ctrl H'      'æ˜¾ç¤ºæ­¤å¸®åŠ©'
  'Ctrl Y'      'å¤åˆ¶æœ€è¿‘è½®å¯¹è¯ç¬¬ 1 ä¸ªä»£ç å—'
  )

  [ "$1" ] && {
    local __chat_help_stat=false
    for i in ${!CHAT_HRLP_MSG[@]};do
      [[ "$i" == "$1" ]] && echo -e "${CHAT_HRLP_MSG["$i"]}\n" && __chat_help_stat=true && return
    done
    [[ "$__chat_help_stat" == false ]] && { echo "æœªæ‰¾åˆ°æŒ‡ä»¤ $1 çš„å¸®åŠ©"; return 1; }
  }

cat <<EOF
${arg0^} ä¼šè¯æŒ‡ä»¤å¸®åŠ©

$(printf "${c35}æŒ‡ä»¤:${c0}")
$(printf "  %s\n" "${CHAT_HRLP_ALL[@]}")

$(printf "${c35}æŒ‰é”®(å…¶ä»–æŒ‰é”®ç»‘å®šè¯·å‚è€ƒ Bash å®˜æ–¹æ–‡æ¡£):${c0}")
$(printf "  ${c32}%-10s${c0}%-4s\n" "${CHAT_KEYS_ALL[@]}")

EOF
}

########################################################################

# é”™è¯¯è¾“å‡ºå¹¶é€€å‡º
# ç”¨æ³•: exmsg <message> <echo option>
# è¾“å…¥: <message> é”™è¯¯ä¿¡æ¯
#       <echo option> ä½¿ç”¨echoå‘½ä»¤è¾“å‡ºé€‰é¡¹ï¼Œå·²å ç”¨ -e
exmsg(){
  exec echo -e $2 "${c0}${c31}é”™è¯¯:${c0} $1" >&2
}

# ä»…é”™è¯¯è¾“å‡º
# ç”¨æ³•: emsg <message> <echo option>
# è¾“å…¥: <message> é”™è¯¯ä¿¡æ¯
#       <echo option> ä½¿ç”¨echoå‘½ä»¤è¾“å‡ºé€‰é¡¹ï¼Œå·²å ç”¨ -e
emsg(){
  echo -e $2 "${c0}${c31}é”™è¯¯:${c0} $1" >&2
}

# å¸¸æ—¶è¾“å‡º
# ç”¨æ³•: msg <message> <echo option>
# è¾“å…¥: <message> è¾“å‡ºä¿¡æ¯
#       <echo option> ä½¿ç”¨echoå‘½ä»¤è¾“å‡ºé€‰é¡¹ï¼Œå·²å ç”¨ -e
msg(){
  echo -e $2 "${c0}${c35}$arg0:${c0} $1"
}

# æ›´å…·äº¤äº’æ€§çš„é”™è¯¯è¾“å‡º
# ç”¨æ³•: erron <message>
# è¡Œä¸ºæ§åˆ¶:
#         å˜é‡ ERRON
#         ä¸º true æ—¶ï¼Œä¼šåœ¨é”™è¯¯è¾“å‡ºå‰æ¸…é™¤å½“å‰è¡Œï¼Œç­‰å¾… 1 ç§’åæ¢å¤
#         ä¸º false æ—¶ï¼Œä¼šç›´æ¥è¾“å‡ºé”™è¯¯ä¿¡æ¯
erron(){
  if $ERRON;then
    printf "${c0}\e[1A\r${ek}"
    emsg "$1${l25}\e[8m" -n
    sleep 1
    printf "\r${h25}\e[28m${ek}"
  else
    emsg "$1" $2
  fi
}

# è°ƒè¯•è¾“å‡º
# ç”¨æ³•: debug <message> <echo option>
# è¾“å…¥: <message> è°ƒè¯•ä¿¡æ¯
#       <echo option> ä½¿ç”¨echoå‘½ä»¤è¾“å‡ºé€‰é¡¹ï¼Œå·²å ç”¨ -e
# è¡Œä¸ºæ§åˆ¶:
#         å˜é‡ DEBUG
#         ä¸º true æ—¶ï¼Œä¼šè¾“å‡ºé¢„å®šçš„è°ƒè¯•ä¿¡æ¯
#         ä¸º false æ—¶ï¼Œä¸ä¼šè¾“å‡ºè°ƒè¯•ä¿¡æ¯
debug(){
  ${DEBUG:-false} && echo -e $2 "${c0}${c33}debug:${c0} $1" >&2
}

# é€€å‡ºæ—¶
# ç”¨æ³•: bye
# è¡Œä¸ºæ§åˆ¶:
#       å˜é‡ trap
#       ä¸º true æ—¶ï¼Œä¼šåœ¨é€€å‡ºå‰è¾“å‡º [Ctrl-C] æç¤º
bye(){
  Wait-Task kill
  printf "${h25}\r${c0}${c32}"
  ${trap:-false} && printf "[Ctrl-C]${c0} "
  msg "$bye_prompt${ek}${c0}"
  exit
}

########################################################################

# åˆ‡æ¢æ¨¡å‹
# ç”¨æ³•: Switch-Model <æ¨¡å‹>
# è¾“å…¥: <æ¨¡å‹> æ¨¡å‹åç§°
Switch-Model(){
  local model=$1
  if [[ -z "$model" ]];then
    erron "è¯·æŒ‡å®šæ¨¡å‹"
    return
  fi
  debug "åˆ‡æ¢æ¨¡å‹ä¸º $model"
  if [[ "$model" == "$(jq -r .model <<<"$data")" ]];then
    msg "é‡å¤çš„è®¾ç½®"
    return
  fi
  if [[ " ${OPENAI_API_MODEL_in_array[*]} " == *" $model "* ]];then
    data="$(jq --arg model "$model" '.model = $model' <<<"$data")"
    old_data="$(jq --arg model "$model" '.model = $model' <<<"$old_data")"
    msg "å·²åˆ‡æ¢ä¸º $model"
  else
    erron "æœªçŸ¥çš„æ¨¡å‹ $model"
  fi
}

########################################################################

# è®¾ç½®ä¼šè¯åŠŸèƒ½
# ç”¨æ³•: Set-Session-Functions <åˆ«å> <true|false>
# è®¾ç½® BAI ä¼šè¯åŠŸèƒ½
# æœªæŒ‡å®š <åˆ«å> æ—¶ï¼Œä¼šä»¥åˆ—è¡¨æ˜¾ç¤ºå½“å‰è®¾ç½®çŠ¶æ€
# æœªæŒ‡å®š <true|false> æ—¶ï¼Œä¼šæ˜¾ç¤º <åˆ«å> å½“å‰çŠ¶æ€
Set-Session-Functions(){
  local alias value type name key
  case "$#" in
    0)
      printf "${c34}%-26s${c35}%-17s${c33}%s${c0}\n" "åˆ«å" "å€¼" "æè¿°"
      for ((i=0;i<${#SET[@]};i++));do
        key=${SET_ALIAS[i]}
        alias=${key%:*}
        description=${SET_DESCRIPTION[i]}
        value=${!SET[i]}
        ((${#value}>=10)) && value="${value:0:10}..."
        printf "${c32}%-24s\e[1;34m%-16s\e[1;37m%s${c0}\n" "$alias" "$value" "$description"
      done
      printf "\n"
      ;;
    1)
      alias=$1
      for ((i=0;i<${#SET[@]};i++));do
        key=${SET_ALIAS[i]}
        type=${key%:*}
        value=${!SET[i]}
        if [[ "$alias" == "$type" ]];then
          debug "æ‰“å° ${1:-Null} çš„å½“å‰è®¾ç½®"
          echo "$value"
          return
        fi
      done
      erron "æœªçŸ¥çš„é€‰é¡¹ $alias"
      ;;
    2)
      alias=$1
      value=$2
      for ((i=0;i<${#SET[@]};i++));do
        key=${SET_ALIAS[i]}
        type=${key#*:}
        option=${key%:*}
        name=${SET[i]}
        if [[ "$alias" == "$option" ]];then
          case $type in
            bool)
              if [[ "${value}" =~ ^(false|true)$ ]];then
                debug "è®¾ç½®é¡¹ä¸ºå¸ƒå°”å€¼: $name çš„å€¼å°†è¢«è®¾ç½®ä¸º $value"
                printf -v "$name" "$value"
                return
              else
                erron "ä»…å…è®¸ä½¿ç”¨å¸ƒå°”å€¼"
                return
              fi
              ;;
            string)
              debug "è®¾ç½®é¡¹ä¸ºå­—ç¬¦ä¸²å€¼: $name çš„å€¼å°†è¢«è®¾ç½®ä¸º $value"
              printf -v "$name" "$value"
              case "$alias" in
                chat-model)
                  Switch-Model "$value"
                  return
                  ;;
              esac
              return
              ;;
            number)
              if [[ "${value}" =~ ^-?[0-9]+(\.[0-9]+)?$ ]];then
                debug "è®¾ç½®é¡¹ä¸ºæ•°å€¼: $name çš„å€¼å°†è¢«è®¾ç½®ä¸º $value"
                printf -v "$name" "$value"
                return
              else
                erron "ä»…å…è®¸ä½¿ç”¨æ•°å€¼"
                return
              fi
              ;;
            *)
              erron "æœªçŸ¥çš„ç±»å‹ $type"
              return
              ;;
          esac
          return
        fi
      done
      erron "æœªçŸ¥çš„é€‰é¡¹ $alias"
  esac
}

########################################################################

# æ£€æŸ¥æ–‡ä»¶ç±»å‹
# ç”¨æ³•: Check-File-Type <æ–‡ä»¶è·¯å¾„>
# è¾“å…¥: <æ–‡ä»¶è·¯å¾„> è¦æ£€æŸ¥çš„æ–‡ä»¶è·¯å¾„
# è¡Œä¸ºæ§åˆ¶:
#       å˜é‡ check_file_type
#       å­˜å‚¨ç›®æ ‡æ–‡ä»¶çš„å¤§è‡´ç±»å‹
# * ä½œä¸ºæ¡ä»¶ç»„ä»¶ä½¿ç”¨æ—¶ï¼Œè¿”å›å€¼ä¸º 0 æ—¶ä¸ºçœŸï¼Œ1 ä¸ºå‡
Check-File-Type(){
  local typeof="$(file -b "${1:--}" 2>/dev/null)"
  local check
  check_file_type=""
  [[ "$typeof" =~ ^(.+UTF-8.+|ASCII text|JSON text data)$ ]]
  case "$typeof" in
  *UTF-8*|ASCII*|*text*)
    check_file_type=text
    check=true
    ;;
  *image*)
    check_file_type=image
    check=true
    ;;
  *)
    check_file_type=unknown
    check=false
    ;;
  esac
  $check
}

# åˆ¤æ–­å˜é‡ç±»å‹
# ç”¨æ³•: Check-Variable-Type <å˜é‡å>
# è¾“å…¥: <å˜é‡å> è¦æ£€æŸ¥çš„å˜é‡å
# è¾“å‡º: å˜é‡ç±»å‹
# ç±»å‹:
#       zero ç©ºå˜é‡
#       array æ•°ç»„
#       number æ•°å€¼
#       url é“¾æ¥
#       boolean å¸ƒå°”å€¼
#       option é€‰é¡¹å‚æ•°
#       string å­—ç¬¦ä¸²
#       unknown æœªçŸ¥ç±»å‹
Check-Variable-Type(){
  if [ -z "${!1}" ];then
    echo "zero"      # ç©ºå˜é‡
  elif declare -p "$1" 2>/dev/null | grep -q 'declare -a';then
    echo "array"     # æ•°ç»„
  elif [[ "${!1}" =~ ^-?[0-9]+(\.[0-9]+)?$ ]];then   
    echo "number"    # æ•°å€¼
  # elif [[ "${!1}" =~ ^([Vv])?[0-9a-zA-Z_-]+(\.[0-9a-zA-Z_-]+)?$ ]];then
  #   echo "version"   # ç‰ˆæœ¬å·ï¼Œè¿™å¯èƒ½ä¸å…¶ä»–ç±»å‹å†²çªï¼Œå°†åˆå¹¶è‡³å­—ç¬¦ä¸²ç±»å‹
  elif [[ "${!1}" =~ ^https?://[0-9a-zA-Z./?=\&%-_]+$ ]];then
    echo "url"       # é“¾æ¥
  elif [[ "${!1,,}" =~ ^(fals|tru)e$ ]];then
    echo "boolean"   # å¸ƒå°”å€¼
  elif [[ "${!1}" =~ ^-{1,2}[0-9a-zA-Z_-]+$ ]];then
    echo "option"    # é€‰é¡¹å‚æ•°
  elif [[ "${!1}" =~ ^.+$ ]];then
    echo "string"    # å­—ç¬¦ä¸²
  else
    echo "unknown"   # æœªçŸ¥ç±»å‹
  fi
}

########################################################################

# ç­‰å¾…é˜»å¡ä»»åŠ¡
# ç”¨æ³•: Wait-Task <wait|kill|pid>
# é€‰é¡¹: <wait|kill|pid>
#       wait æ°¸è¿œç­‰å¾…
#       kill æ€æ­»è¿›ç¨‹ ï¼ˆwaitï¼‰
#       pid è¿›ç¨‹ PID
# è¡Œä¸ºæ§åˆ¶:
#       å˜é‡ CHAT
#       ä¸º true æ—¶ï¼Œä¼šåœ¨ç­‰å¾…è¿‡ç¨‹ä¸­è¾“å‡ºæç¤ºä¿¡æ¯
#       ä¸º false æ—¶ï¼Œ<wait> ä¼šç«‹å³è¿”å›
Wait-Task(){
  [ "$__wait_task_frame" ] || Switch-Wait-Frame "${BAI_WAIT_STYLE:-}"
  local ARG1="$1"
  local ARG2="$2"
  local wait_prompt="${l25}\r\e[1;32m%s${c0} ${2:-"æ­£åœ¨ç­‰å¾…"}"
  local exit_prompt="${h25}\r${ek}"
  case "${ARG1:-null}" in
    null)return;;
    wait) 
    # æ°¸è¿œç­‰å¾…
      Set-Osc-Progress doubt
      while $CHAT;do
        for i in "${__wait_task_frame[@]}";do
          printf "$wait_prompt" "$i" >&2
          sleep 0.05
        done
      done &
      GETWAIT_PID=$!
      ;;
    kill)
    # æ€æ­»è¿›ç¨‹ ï¼ˆwaitï¼‰
      Set-Osc-Progress clear
      if kill -0 "$GETWAIT_PID" &>/dev/null;then
        kill "$GETWAIT_PID" &>/dev/null
        printf "$exit_prompt" >&2
      fi
      ;;
    *) 
    # ä½¿ç”¨ kill å‘½ä»¤åˆ¤æ–­è¿›ç¨‹å­˜åœ¨ï¼Œä¸å­˜åœ¨å³åœæ­¢ç­‰å¾…
      Set-Osc-Progress doubt
      while $CHAT;do
        for i in "${__wait_task_frame[@]}";do
          if kill -0 "$ARG1" &>/dev/null;then
            printf "$wait_prompt" "$i" >&2
            sleep 0.05
          else
            printf "$exit_prompt" >&2
            Set-Osc-Progress clear
            exit 0
          fi
        done
      done
  esac
}

########################################################################

# åˆ‡æ¢åŠ è½½ç­‰å¾…å¸§æ ·å¼
# ç”¨æ³•: Switch-Wait-Frame <æ ·å¼>
# é€‰é¡¹:
#       <æ ·å¼> ç­‰å¾…å¸§æ ·å¼
# æ ·å¼:
#       bar è¿›åº¦æ¡
#       arc åœ†å¼§
#       dot ç‚¹
#       line çº¿
#       bell é’Ÿ
#       wave æ³¢
#       roll æ»šåŠ¨
#       block æ–¹å—
#       arrow ç®­å¤´
#       square æ­£æ–¹å½¢
#       pushpull æ¨åŠ¨æ‹‰åŠ¨
# è¡Œä¸ºæ§åˆ¶:
#       å‡½æ•° Wait-Task
#       ä¸º Wait-Task åˆ‡æ¢ç­‰å¾…å¸§æ ·å¼ï¼Œé»˜è®¤ä¸º bar
Switch-Wait-Frame(){
  case "${1:-bar}" in
    bar) __wait_task_frame=("\\" "|" "/" "-");;
    arc)  __wait_task_frame=("î¸†" "î¸‡" "î¸ˆ" "î¸‰" "î¸Š" "î¸‹");;
    dot)  __wait_task_frame=(".  " ".  " ".  " ".. " ".. " ".. " "..." "..." "...");;
    line) __wait_task_frame=("_  " "_  " " _ " " _ " "  _" "  _" " _ " " _ ");;
    bell) __wait_task_frame=("ğŸ•" "ğŸ•‘" "ğŸ•’" "ğŸ•“" "ğŸ•”" "ğŸ••" "ğŸ•–" "ğŸ•—" "ğŸ•˜" "ğŸ•™" "ğŸ•š" "ğŸ•›");;
    dice) __wait_task_frame=("âš€" "âš" "âš‚" "âšƒ" "âš„" "âš…");;
    wave) __wait_task_frame=("â–" "â–‚" "â–ƒ" "â–„" "â–…" "â–†" "â–‡" "â–ˆ" "â–‡" "â–†" "â–…" "â–„" "â–ƒ" "â–‚");;
    roll) __wait_task_frame=("Loading... " "oading... L" "ading... Lo" "ding... Loa" "ing... Load" "ng... Loadi" "g... Loadin" "... Loading" ".. Loading." ". Loading.." " Loading...");;
    block) __wait_task_frame=("â– â–¡â–¡" "â– â–¡â–¡" "â–¡â– â–¡" "â–¡â– â–¡" "â–¡â–¡â– " "â–¡â–¡â– " "â–¡â– â–¡" "â–¡â– â–¡");;
    phase) __wait_task_frame=("ğŸŒ•" "ğŸŒ–" "ğŸŒ—" "ğŸŒ˜" "ğŸŒ‘" "ğŸŒ’" "ğŸŒ“" "ğŸŒ”");;
    arrow) __wait_task_frame=("â†’" "â†˜" "â†“" "â†™" "â†" "â†–" "â†‘" "â†—");;
    square) __wait_task_frame=("â—°" "â—³" "â—²" "â—±");;
    points) __wait_task_frame=("ğ„™" "ğ„š" "ğ„›" "ğ„œ" "ğ„" "ğ„" "ğ„Ÿ" "ğ„ " "ğ„¡");;
    pushpull) __wait_task_frame=("â–" "â–" "â–" "â–Œ" "â–‹" "â–Š" "â–‰" "â–ˆ" "â–‰" "â–Š" "â–‹" "â–Œ" "â–" "â–");;
    invisible) __wait_task_frame=("Loading..." " oading..." "  ading..." "   ding..." "    ing..." "     ng..." "      g..." "       ..." "        .." "         ." "          " "L         " "Lo        " "Loa       " "Load      " "Loadi     " "Loadin    " "Loading   " "Loading.  " "Loading.. ");;
    dotmatrix) __wait_task_frame=('â£·' 'â£¯' 'â£Ÿ' 'â¡¿' 'â¢¿' 'â£»' 'â£½' 'â£¾');;
    rectangle) __wait_task_frame=("â–›" "â–™" "â–œ" "â–Ÿ");;
  esac
}

########################################################################

# å¯¹æ”¯æŒ OSC94 åè®®çš„ç»ˆç«¯è®¾ç½®è¿›åº¦æ çŠ¶æ€
# ç”¨æ³•: Set-Osc-Progress <çŠ¶æ€> <è¿›åº¦>
# é€‰é¡¹:
#       <çŠ¶æ€> è¿›åº¦æ çŠ¶æ€
#       <è¿›åº¦> è¿›åº¦å€¼
# çŠ¶æ€:
#       info æ­£å¸¸çš„
#       error é”™è¯¯çš„
#       doubt ä¸ç¡®å®šçš„
#       warning è­¦å‘Š
#       clear é‡ç½®çŠ¶æ€
# è¿›åº¦:
#       * 0-100 æ•´æ•°å€¼
#       * `:` åˆ†éš”çš„ä¸¤ä¸ªæ•´æ•°å€¼ï¼š<å½“å‰è¿›åº¦:æ€»è¿›åº¦>ï¼Œè‡ªåŠ¨è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
# è¡Œä¸ºæ§åˆ¶:
#       å‡½æ•° Wait-Task
#       Wait-Task å°†å¯¹å…¶è®¾ç½®è¿›åº¦æ çŠ¶æ€ doubtï¼Œå®Œæˆåè‡ªåŠ¨é‡ç½®
Set-Osc-Progress(){
  $CONEMU_STATUS || return
  local _wt_prompt="\e]9;4;%d;%d\a"
  local _arg2="$2"
  [[ "$_arg2" == *:* ]] && {
    local _all_progress="${_arg2#*:}"
    local _current_progress="${_arg2%:*}"
    local _arg2="$((_current_progress*100/_all_progress))"
  }
  local_num_range(){ 
    local _type=`Check-Variable-Type _arg2`
    [[ "$_type" == number ]] || return 1
    [[ "$_arg2" =~ ^([0-9]|[1-9][0-9]|100)$ ]] || return 1
  }
  case "${1:-clear}" in
    # æ­£å¸¸çš„
    info)
      local_num_range || return
      printf "$_wt_prompt" 1 "$_arg2" >&2
      ;;
    # é”™è¯¯çš„
    error)
      local_num_range || return
      printf "$_wt_prompt" 2 "$_arg2" >&2
      ;;
    # ä¸ç¡®å®šçš„
    doubt)
      printf "$_wt_prompt" 3 0 >&2
      ;;
    # è­¦å‘Š
    warning)
      local_num_range || return
      printf "$_wt_prompt" 4 "$_arg2" >&2
      ;;
    # é‡ç½®çŠ¶æ€
    clear|*)
      printf "$_wt_prompt" 0 0 >&2
      ;;
  esac
}

########################################################################

# é™åˆ¶æ–‡ä»¶å¤§å°
# ç”¨æ³•: Limit-FileSize <æ–‡ä»¶è·¯å¾„> <å¤§å°èŒƒå›´>
# é€‰é¡¹:
#       <æ–‡ä»¶è·¯å¾„> è¦æ£€æŸ¥çš„æ–‡ä»¶è·¯å¾„
#       <å¤§å°èŒƒå›´> å¤§å°èŒƒå›´ï¼Œæ ¼å¼ä¸º <æœ€å°å€¼>,<æœ€å¤§å€¼>ï¼Œå•ä½ä¸ºå­—èŠ‚
Limit-FileSize(){
  sys_size=$(du -sb "$1" | cut -f1) # æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  min_size=${2%,*}                  # ä¾‹ï¼šæœ€å° 5 å­—èŠ‚
  max_size=${2#*,}                  # ä¾‹ï¼šæœ€å¤§ 10 åƒå­—èŠ‚
  (((sys_size<min_size))||((sys_size>max_size))) &&
  exmsg "$arg: å‘½ä»¤æç¤ºæ–‡ä»¶å†…å®¹ä¸å¾— [å¤§äº $max_size] / [å°äº $min_size]"
}

########################################################################

# åˆ¤æ–­å“åº”é”™è¯¯
# ç”¨æ³•: Get-Assistant-ReturnError <å“åº”ä½“>
# é€‰é¡¹:
#       <å“åº”ä½“> è¦æ£€æŸ¥çš„å“åº”ä½“
# æ¡ä»¶ä¾æ®:
#       JSON å“åº”ä½“ä¸­å¿…é¡»åŒ…å« ".error.message" å­—æ®µ
Get-Assistant-ReturnError(){
  if jq -e '.error' <<< "$1" &>/dev/null;then
    ERROR_MSG=$(jq --exit-status -r '.error.message' <<< "$1" 2>/dev/null)
    API_STATUS=$?
    if ((API_STATUS)) && [[ "$ERROR_MSG" == "null" ]];then
      ERROR_MSG="è¯¥æ¬¡è¯·æ±‚æœªæ­£ç¡®è¢«æ¥å—"
    fi
    erron "$ERROR_MSG"
    return 1
  fi
}

########################################################################

# BAI æ ¸å¿ƒè¯·æ±‚ä½“
# ç”¨æ³•: Get-Assistant-Return
# è¡Œä¸ºæ§åˆ¶:
#       å˜é‡ OPENAI_BASE_URL[1]*, API_AUTH[2]*, data[3]*
#       1* åŸºç¡€ URL
#       2* API è®¤è¯
#       3* è¯·æ±‚ä½“
Get-Assistant-Return(){
  curl -s -X POST \
    "$OPENAI_BASE_URL/chat/completions" \
    -H "$API_AUTH" \
    -H "Content-Type: application/json" \
    -d "$data" 2>/dev/null ||
  printf '{"error": {"message": "æ— æ³•å¤„ç†æ­¤è¯·æ±‚"}}'
}

########################################################################

# è·å–å‘½ä»¤è¾“å‡º
# ç”¨æ³•: Get-Command-Output <å‘½ä»¤>
# é€‰é¡¹:
#       <å‘½ä»¤> è¦æ‰§è¡Œçš„å‘½ä»¤
# è¡Œä¸ºæ§åˆ¶:
#       å˜é‡ gco_return_content
#       å‘½ä»¤æ‰§è¡Œå®Œæˆåï¼Œå°†è¾“å‡ºå†…å®¹å­˜å‚¨åœ¨å˜é‡ gco_return_content ä¸­
#       å˜é‡ gco_status
#       å‘½ä»¤æ‰§è¡Œå®Œæˆåï¼Œå°†é€€å‡ºçŠ¶æ€å­˜å‚¨åœ¨å˜é‡ gco_status ä¸­
#       å˜é‡ explicitly
#       ä¸º true æ—¶ï¼Œå‘½ä»¤æ‰§è¡Œå®Œæˆåï¼Œè¾“å‡ºå†…å®¹å°†å­˜å‚¨åœ¨å˜é‡ gco_return_contentï¼ŒåŒæ—¶æ‰“å°åˆ°ç»ˆç«¯
#       ä¸º false æ—¶ï¼Œå‘½ä»¤æ‰§è¡Œå®Œæˆåï¼Œè¾“å‡ºå†…å®¹ä»…å­˜å‚¨åœ¨å˜é‡ gco_return_content ä¸­ï¼Œä¸ä¼šæ‰“å°è‡³ç»ˆç«¯
Get-Command-Output(){
  gco_return_content="${
    Wait-Task wait "å·¥å…·æ­£åœ¨æ‰§è¡Œå‘½ä»¤"
    eval "$*" 2>&1 |
    if ${explicitly:-false};then
      tee /dev/tty
    else
      cat
    fi
    gco_status=$PIPESTATUS
    Wait-Task kill
  }"
}

########################################################################

# è®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ Levenshtein è·ç¦»
# ç”¨æ³•: Get-Levenshtein <å­—ç¬¦ä¸²1> <å­—ç¬¦ä¸²2>
# é€‰é¡¹:
#       <å­—ç¬¦ä¸²1> è¦æ¯”è¾ƒçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²
#       <å­—ç¬¦ä¸²2> è¦æ¯”è¾ƒçš„ç¬¬äºŒä¸ªå­—ç¬¦ä¸²
Get-Levenshtein(){
  local str1="$1"
  local str2="$2"
  local len1=${#str1}
  local len2=${#str2}
  declare -A dp
  for ((i=0;i<=len1;i++));do
    dp[$i,0]="$i"
  done
  for ((j=0;j<=len2;j++));do
    dp[0,$j]="$j"
  done
  for ((i=1;i<=len1;i++));do
    for ((j=1;j<=len2;j++));do
      [[ "${str1:i-1:1}" == "${str2:j-1:1}" ]] && cost=0 ||cost=1
      insert="$((dp[$((i)),$((j-1))] + 1))"
      delete="$((dp[$((i-1)),$((j))] + 1))"
      replace="$((dp[$((i-1)),$((j-1))] + cost))"
      dp[$i,$j]="$(($insert < $delete ? ($insert < $replace ? $insert : $replace) : ($delete < $replace ? $delete : $replace)))"
    done
  done
  echo "${dp[$len1,$len2]}"
}

########################################################################

# GNU å®ç”¨ç¨‹åºç‰ˆæœ¬
# ç”¨æ³•: Print-Command-Version <å‘½ä»¤>
# é€‰é¡¹:
#       <å‘½ä»¤> è¦æ£€æŸ¥çš„å‘½ä»¤ï¼ŒåŸºæœ¬ç¬¦åˆ GNU è§„èŒƒ
Print-Command-Version(){
  $1 --version | head -1 | cut -d' ' -f2- | sed 's/(//;s/)//' | Print-HighLight-Number || echo Null
}

# é«˜äº®æ•°å­—
# ç”¨æ³•: Print-HighLight-Number <å­—ç¬¦ä¸²>
# é€‰é¡¹:
#       <å­—ç¬¦ä¸²> è¦é«˜äº®çš„å­—ç¬¦ä¸²
Print-HighLight-Number(){
  sed -E "s/([0-9]+)/\\${c34}\1\\${c0}/g"
}

########################################################################

# ä»æ¨¡å‹è¾“å‡ºæ‰§è¡Œå‘½ä»¤
# ç”¨æ³•: Get-Assistant-Command
# è¡Œä¸ºæ§åˆ¶:
#       å˜é‡ API_RETURN[1]*, EVAL[2]*, RCSAA[3]*
#       1* æ¨¡å‹è¾“å‡º
#       2* è¯„ä¼°çŠ¶æ€
#       3* ç¡®è®¤æ‰§è¡ŒçŠ¶æ€
Get-Assistant-Command(){
  debug "æ­£åœ¨å¤„ç†æ¨¡å‹è¾“å‡º..."
  local eval_code="$(Get-MarkDown-CodeBlocks cat 1 <<<"$API_RETURN" || echo Null)"
  [[ "$eval_code" == Null ]] && return
  if grep -qP '^\s*[\p{Han}]|^`' <<< "$eval_code";then
    cat <<< "$eval_code"
    erron "éæ³•çš„å‘½ä»¤å†…å®¹"
  else
    echo -e "\e[1;34m$eval_code${c0}"
    if ! $RCSAA;then
      if $__has_extend_gum;then
        gum confirm "æ‰§è¡Œå‘½ä»¤ï¼Ÿ" && choose=y || choose=n
      else
        msg "æ‰§è¡Œå‘½ä»¤ï¼Ÿ[y/N] " -n
        read choose
      fi
    fi
    $RCSAA && choose=yes
    local choose="${choose,,}"
    case "${choose:-no}" in
      yes|y)
        bash -ic "$eval_code"
        ;;
      no|n)
        echo -e "${c33}å–æ¶ˆ${c0}"
    esac
  fi
  EVAL=false
}

########################################################################

# ä» MarkDown è·å–å¹¶è¾“å‡ºä»£ç å—å†…å®¹
# ç”¨æ³•: Get-MarkDown-CodeBlocks [cat|ç¼–å·] [ç¼–å·]
# é€‰é¡¹:
#       cat  ç›´æ¥è¾“å‡ºä»£ç å—å†…å®¹ï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†
#       ç¼–å· è¦æå–çš„ä»£ç å—ç¼–å·ï¼Œä» 1 å¼€å§‹
# è¡Œä¸ºæ§åˆ¶:
#       æ ‡å‡†è¾“å…¥
#       ä»æ ‡å‡†è¾“å…¥è·å– MarkDown å†…å®¹
Get-MarkDown-CodeBlocks(){
  [ -t 0 ] && return
  local content="$(cat)"
  local cat=false
  [[ "$1" && "$1" == "cat" ]] && {
    local cat=true
    shift
  }
  local block_number="$1"
  # å¦‚æœæŒ‡å®šäº†ä»£ç å—ç¼–å·ï¼Œç¡®ä¿å…¶ä¸ºæ­£æ•´æ•°
  [ -n "$block_number" ] && { [[ "$block_number" =~ ^[0-9]+$ ]] || return;}
  # ä½¿ç”¨ awk æå–ä»£ç å—ä¿¡æ¯
  local total_blocks=$(awk '/^\s*```/ { count++ } END { print count / 2 }' <<< "$content")
  ((total_blocks)) || {
    msg "å¯¹è¯ä¸­æ— ä»£ç å—" >&2
    return 1
  }
  # å¦‚æœæœªæŒ‡å®šä»£ç å—ç¼–å·ï¼Œæç¤ºç”¨æˆ·å¯ç”¨çš„ä»£ç å—æ•°é‡
  if [ -z "$block_number" ];then
      msg "åœ¨å¯¹è¯ä¸­æ‰¾åˆ° $total_blocks ä¸ªä»£ç å—"
      return
  fi
  # å¦‚æœæŒ‡å®šçš„ä»£ç å—ç¼–å·è¶…å‡ºèŒƒå›´
  if [ "$block_number" -gt "$total_blocks" ];then
      emsg "æŒ‡å®šæå–ç¬¬ $block_number ä¸ªä»£ç å—ï¼Œä½†æ˜¯å¯¹è¯ä¸­æœ‰ $total_blocks ä¸ªä»£ç å—ï¼Œå·²è¶…å‡ºèŒƒå›´"
      return
  fi
  # ä½¿ç”¨ awk æå–æŒ‡å®šçš„ä»£ç å—å†…å®¹ï¼Œå»æ‰ä»£ç å—çš„å¼€å§‹å’Œç»“æŸæ ‡è®°
  local code="$(
    awk -v block="$block_number" '
    BEGIN {
        in_code_block = 0
        block_count = 0
    }
    {
        if ($0 ~ /^\s*```/) {
            if (in_code_block) {
                # ç»“æŸå½“å‰ä»£ç å—
                in_code_block = 0
                if (block_count == block) {
                    # å¦‚æœæ‰¾åˆ°æŒ‡å®šçš„ä»£ç å—ï¼Œé€€å‡º
                    exit
                }
            } else {
                # å¼€å§‹æ–°çš„ä»£ç å—
                in_code_block = 1
                block_count++
            }
        } else if (in_code_block) {
            if (block_count == block) {
                # å¦‚æœæ˜¯ç›®æ ‡ä»£ç å—ï¼Œæ‰“å°å†…å®¹
                print $0
            }
        }
    }' <<<"$content"
  )"
  if "$cat";then
    if $__has_extend_bat;then
      local __bat_language="$(
        awk -v block="$block_number" '
        /^\s*```/ { 
          if (in_code_block) {
            in_code_block = 0
          } else {
            in_code_block = 1
            block_count++
            if (block_count == block) {
              match($0, /^\s*```(\S+)/, arr)
              print arr[1] ? arr[1] : "txt"
              exit
            }
          }
        }' <<<"$content"
      )"
      local __if_bat_language="-l $__bat_language"
      bat --no-pager --plain $__if_bat_language <<<"$code" 2>/dev/null || cat <<<"$code"
    else
      cat <<<"$code"
    fi
  else
    printf "\e]52;c;$(base64 <<<"$code")\a"
    msg "å·²å¤åˆ¶ç¬¬ $block_number ä¸ªä»£ç å—"
  fi
}


########################################################################

# è¾…åŠ©æ£€æŸ¥å·¥å…·é”™è¯¯
# ç”¨æ³•: Check-Tools-Seq <å·¥å…·æ‰€å¤„è¡Œå·>
# é€‰é¡¹:
#       è¡Œå· å·¥å…·æ‰€å¤„è¡Œå·ï¼ŒæŒ‡å®šå¤šä¸ª
# è¡Œä¸ºæ§åˆ¶:
#       å‡½æ•° Check-Tools
#       Check-Tools å°†æœ¬å‡½æ•°ä½œä¸ºè¾…åŠ©å®¡æŸ¥ç»„ä»¶ä½¿ç”¨ï¼Œå°†ä»¥æ˜“äºé˜…è¯»çš„æ–¹å¼è¾“å‡ºé”™è¯¯ä½ç½®
Check-Tools-Seq(){
  # å°†è¾“å…¥çš„åºåˆ—ä»¥ç©ºæ ¼åˆ†éš”å¹¶å­˜å‚¨åˆ°æ•°ç»„ä¸­
  local expected_total="$(cat | wc -l)"
  local sequence=($@)
  local total=${#sequence[@]}
  # å¦‚æœåºåˆ—æ•°é‡ç­‰äºæ–‡ä»¶æ€»è¡Œæ•°ï¼Œè¾“å‡ºâ€œå…¨éƒ¨åºåˆ—å·²è¢«æ£€æŸ¥â€
  if [[ $total -eq $expected_total ]]; then
    echo "é”™è¯¯åœ¨æ‰€æœ‰è¡Œå‡å­˜åœ¨ï¼Œ$arg0 è®¤ä¸ºè¯¥æ–‡ä»¶å¹¶éå·¥å…·æ–‡ä»¶ï¼Œè¯·ç¡®ä¿å‚æ•°è¢«æ­£ç¡®ä½¿ç”¨"
    return
  fi
  # åˆå§‹åŒ–å˜é‡
  local result=
  local start=${sequence[0]}
  local end=${sequence[0]}
  local prev=${sequence[0]}
  # éå†åºåˆ—
  for ((i=1;i<total;i++));do
    if [[ ${sequence[i]} -eq $((prev+1)) ]]; then
      # å¦‚æœå½“å‰åºå·ä¸å‰ä¸€ä¸ªåºå·è¿ç»­ï¼Œæ›´æ–°ç»“æŸåºå·
      end=${sequence[i]}
    else
      # å¦‚æœä¸è¿ç»­ï¼Œå°†å½“å‰è¿ç»­æ®µåŠ å…¥ç»“æœ
      if [[ $start -eq $end ]]; then
        result+="è¡Œ $start, "
      else
        result+="è¡Œ $start è‡³è¡Œ $end, "
      fi
      # é‡ç½®å¼€å§‹å’Œç»“æŸåºå·
      start=${sequence[i]}
      end=${sequence[i]}
    fi
    prev=${sequence[i]}
  done
  # æ·»åŠ æœ€åä¸€ä¸ªè¿ç»­æ®µ
  if [[ $start -eq $end ]]; then
    result+="è¡Œ $start"
  else
    result+="è¡Œ $start è‡³è¡Œ $end"
  fi
  # è¾“å‡ºç»“æœ
  echo "ä½äº$result"
}


# å®¡æŸ¥ fc å·¥å…·å®Œæ•´æ€§
# ç”¨æ³•: Check-Tools <å·¥å…·æ–‡ä»¶>
# é€‰é¡¹:
#       å·¥å…·æ–‡ä»¶ å·¥å…·æ–‡ä»¶è·¯å¾„
Check-Tools(){
  local _lines=`wc -l "$1" | cut -d' ' -f1`
  ((_lines)) || exmsg "$arg: $1: å·¥å…·ä¸å¯ç”¨ï¼Œæ–‡ä»¶æ¢è¡Œå°‘äº 1ï¼Œæ— æ³•è¿›è¡Œåˆæ­¥å®¡æŸ¥"
  local _n=1
  local _error=0
  local _error_tools=0
  local _error_jsonl=0
  local _jsonl_syntax_error_lines=()
  local _tools_syntax_error_lines=()
  while IFS= read -r line;do
    if (jq . <<< "$line" &>/dev/null);then
      `jq '
        ((.name | type == "string") and
        (.function | type == "string") and
        (.description | type == "string") and
        (.parameters.type == "object") and
        (.parameters.required | type == "array")) or
        ((.name | type == "string") and
        (.description | type == "string") and
        (.function | type == "string") and
        (has("parameters") | not))
      ' <<< "$line" 2>/dev/null` || {
        _tools_syntax_error_lines+=($_n)
        let _error_tools++
        let _error++
      }
    else
      _jsonl_syntax_error_lines+=($_n)
      let _error_jsonl++
      let _error++
    fi
    let _n++
  done < "$1"
  if ((_error));then
    emsg "${arg/?"$1"/}: ${c34}$1${c0}: å·¥å…·ä¸å¯ç”¨"
    if ((_error_jsonl));then
      printf "    ${c33}JSON è¯­æ³•é”™è¯¯:${c0} "
      Check-Tools-Seq ${_jsonl_syntax_error_lines[@]} < "$1"
    fi
    if ((_error_tools));then
      printf "    ${c33}å·¥å…·æ ¼å¼å¼‚å¸¸:${c0} "
      Check-Tools-Seq ${_tools_syntax_error_lines[@]} < "$1"
    fi
    exit
  fi
}

########################################################################

# å‘å¯¹è¯æäº¤æ–‡ä»¶
# ç”¨æ³•: Get-Import-File <æ–‡ä»¶è·¯å¾„>
# é€‰é¡¹:
#       æ–‡ä»¶è·¯å¾„ è¦æäº¤çš„æ–‡ä»¶è·¯å¾„
Get-Import-File(){
  filepath="${subargs[1]}"
  if [ -z $filepath ];then
    erron "æœªè¾“å…¥æ–‡ä»¶"
    return
  fi
  if [ -f $filepath ];then
    if ! Check-File-Type "$filepath";then
      erron "éæ³•çš„æ–‡ä»¶ç±»å‹"
      return
    fi
    filesize=$(stat -c %s "$filepath")
    case "$check_file_type" in
      text)
        # å¦‚æœæ–‡ä»¶å¤§å°å¤§äº 100KBï¼Œæ‹¦æˆªæ­¤è¯·æ±‚
        if ((filesize>102400));then
          erron "è¿‡å¤§çš„æ–‡ä»¶ (${filesize}B)"
          return
        fi
        if [ -z "$old_filepath" ];then
          msg "æäº¤æ–‡ä»¶ $filepath"
        else
          msg "è¦†ç›–æäº¤æ–‡ä»¶ $filepath => $old_filepath"
        fi
        STDIN_INPUT="$(echo "File: $filepath";echo "@File Content Head";cat -n "$filepath" | sed -E 's/^([[:space:]]*[0-9]+)/\1 |/g')"$'\n@File Content Tail\n'
        debug "å‘æ ‡å‡†è¾“å…¥æäº¤æ–‡ä»¶"
        old_filepath="$filepath"
        ;;
      image)
        # å¦‚æœæ–‡ä»¶å¤§å°å¤§äº 5MBï¼Œæ‹¦æˆªæ­¤è¯·æ±‚
        if ((filesize>5242880));then
          erron "è¿‡å¤§çš„æ–‡ä»¶ (${filesize}B)"
          return
        fi
        if [ -z "$old_filepath" ];then
          msg "æäº¤å›¾ç‰‡ $filepath"
        else
          msg "è¦†ç›–æäº¤å›¾ç‰‡ $filepath => $old_filepath"
        fi
        msg "æ³¨æ„: å›¾ç‰‡ä¸Šä¼  (Base64) ä¸ºå®éªŒæ€§åŠŸèƒ½ï¼Œæš‚æ— æ³•æ­£å¸¸ä½¿ç”¨"
        IS_PUSH_IMAGE=true
        IMAGE_INPUT="$(printf 'data:image/png;base64,';base64 $filepath)"
        debug "å‘æ ‡å‡†è¾“å…¥æäº¤å›¾ç‰‡ (æ•°æ®æ ¼å¼: 'data:image/png;base64,{base64_content}')"
        old_filepath="$filepath"
        ;;
    esac
  else
    emsg "$arg: $filepath: æ–‡ä»¶ä¸å­˜åœ¨"
  fi
}

########################################################################

# å¯¼å…¥å¯¼å‡ºå¯¹è¯è®°å½•
# ç”¨æ³•: Get-Session-Messages <æ–‡ä»¶> <æ“ä½œ> [è¡Œä¸º]
# é€‰é¡¹:
#       æ“ä½œ æ“ä½œç±»å‹ï¼Œå¯é€‰å€¼ä¸º exportã€import
#       å‚æ•° æ“ä½œå‚æ•°ï¼Œå¯é€‰
#            æ“ä½œå‚æ•°ï¼ˆexportï¼‰:
#            @no:system é»˜è®¤è¡Œä¸ºåŸºç¡€ä¸Šä¸åŒ…å«ç³»ç»Ÿæ¶ˆæ¯
#            @no:tool é»˜è®¤è¡Œä¸ºåŸºç¡€ä¸Šä¸åŒ…å«å·¥å…·è°ƒç”¨è®°å½•
#            @use:all åŒ…å«æ‰€æœ‰è®°å½•ï¼ŒåŒ…æ‹¬è¯·æ±‚ä½“ä¸­çš„å‚æ•°ï¼Œæ­¤è¡Œä¸ºä»…å…¼å®¹å¯¼å…¥messagesè®°å½•ï¼ˆæ³„éœ²é£é™©è¾ƒé«˜ï¼‰
#            @default é»˜è®¤è¡Œä¸ºï¼ŒåŒ…å«messageå†…æ‰€æœ‰è®°å½•ï¼Œä¸åŒ…å«è¯·æ±‚ä½“ä¸­çš„å‚æ•°
# * å¦‚æœ‰ç”¨æˆ·ååˆ™åœ¨æ‰€æœ‰è¡Œä¸ºä¸­æ·»åŠ ç”¨æˆ·å
Get-Session-Messages(){
  function __subfunction_ask(){
    if $__has_extend_gum;then
      if gum confirm "${!2}";then
        get_session_import_or_export="$1"
      else
        msg "å–æ¶ˆ"
        return 1
      fi
    else
      msg "${!2}[Y/n] " -n
      read confirm
      if [[ "${confirm:=Y}" =~ ^[Yy]$ ]];then
        get_session_import_or_export="$1"
      else
        msg "å–æ¶ˆ"
        return 1
      fi
    fi
  }
  get_session_import_or_export=""
  local get_session_params
  local get_session_json
  local import_ask="å¯¼å…¥å¯¹è¯è®°å½•å°†è¦†ç›–å½“å‰å¯¹è¯è®°å½•ï¼Œç¡®å®šå—ï¼Ÿ"
  local export_ask="å¯¼å‡ºå¯¹è¯è®°å½•å°†è¦†ç›–å½“å‰æ–‡ä»¶ï¼Œç¡®å®šå—ï¼Ÿ"
  [[ "$1" && -f "$1" ]] || { emsg "æœªæŒ‡å®šæ–‡ä»¶"; return 1;}
  case "$2" in
    export)
      jq -e '.messages | length > 0' <<< "$data" &>/dev/null || { emsg "å¯¹è¯è®°å½•ä¸ºç©º"; return 1;}
      ((__turns)) || { emsg "å¯¹è¯è®°å½•ä¸ºç©º"; return 1;}
      __subfunction_ask "false" export_ask
      ;;
    import)
      __subfunction_ask "true" import_ask
      ;;
    *)
      [ "$2" ] && emsg "æœªæŒ‡å®šæ“ä½œ" && return 1
      emsg "æœªçŸ¥æ“ä½œ $2"
      return 1
      ;;
  esac

  case "${3:-@default}" in
    @no:system)
      get_session_params='{ messages: [ .messages[] | select(.role != "system") ] }'
      ;;
    @no:tool)
      get_session_params='{ messages: [ .messages[] | select(.role != "tool") ] }'
      ;;
    @use:all)
      get_session_params='. + { content_type: "application/json", url: $baseurl + "/chat/completions", apikey: $apikey, client: "bai-cli (github.com/hornleaf)", export_date: now }'
      ;;
    @default)
      get_session_params='{ messages: [.messages[]]}'
      ;;
    *)
      emsg "æœªçŸ¥è¡Œä¸º $3"
      return 1
      ;;
  esac
  
  if $get_session_import_or_export;then
    # æ ¡éªŒæ•°æ®ç»“æ„ï¼Œmessage[]ä¸­å¯¹è±¡åŒ…å«roleå’Œcontentå³å¯
    jq -e '.messages[] | has("role") and has("content")' "$1" &>/dev/null || { emsg "#import: æ•°æ®ç»“æ„é”™è¯¯"; return 1;}
    get_session_json="$(jq -r '[.messages[]]' "$1")" || { emsg "#import: è¯»å–å¯¹è¯è®°å½•å¤±è´¥"; return 1;}
    data="$(jq -r --argjson messages "$get_session_json" '.messages =$messages' <<< "$data")" || { emsg "#import: å†™å…¥å¯¹è¯è®°å½•å¤±è´¥"; return 1;}
    __turns="$(jq '[.messages[] | select(.role == "user")] | length' <<< "$data")"
    if jq -e '.username' "$1" &>/dev/null;then
      BAI_USERNAME="$(jq -r '.username' "$1")"
      data="$(jq -r --arg username "$BAI_USERNAME" '. + { username: $username }' <<< "$data")"
      get.session.title
      $CHAT && Set-Terminal-Title "$BAI_TITLE"
    fi
    msg "#import: è®°å½•å¯¼å…¥æˆåŠŸ"
  else
    get_session_json="$(jq -r --arg baseurl "$OPENAI_BASE_URL" --arg model "$OPENAI_API_MODEL" --arg apikey "$OPENAI_API_KEY" "$get_session_params" <<< "$data" | (if [ "$BAI_USERNAME" ];then jq --arg username "$BAI_USERNAME" '. + { username: $username }';else cat;fi))" || { emsg "#export: è¯»å–å¯¹è¯è®°å½•å¤±è´¥"; return 1;}
    echo "$get_session_json" > "$1"
    msg "#export: è®°å½•å¯¼å‡ºæˆåŠŸ"
  fi
}

########################################################################

# æŸ¥çœ‹å¯¹è¯è®°å½•
# ç”¨æ³•: Get-Session-History
# é€‰é¡¹:
#       æ— 
# è¡Œä¸ºæ§åˆ¶:
#       å˜é‡ __has_extend_bat
#       è‹¥ä¸º true åˆ™ä½¿ç”¨ batï¼Œå¦åˆ™ä½¿ç”¨ less
Get-Session-History(){
  ((__turns)) || { emsg "å¯¹è¯è®°å½•ä¸ºç©º"; return 1;}
  local session_username="${BAI_USERNAME:-"ç”¨æˆ·"}"
  if jq -e '.username' <<< "$data" &>/dev/null;then
    session_username="$(jq -r '.username' <<< "$data")"
  fi
  local __jq_reg="
    .messages[] |
    if .role == \"system\" then
      \"\e[35mç³»ç»Ÿ:\e[0m \" + .content
    elif .role == \"user\" then
      \"\e[32m${session_username}:\e[0m \" + .content
    elif .role == \"assistant\" then
      if .tool_calls then
        \"\e[34måŠ©æ‰‹:\e[0m å°†è°ƒç”¨å‡½æ•° \e[35m\" + .tool_calls[0].function.name + \"\e[0m\"
      else
        if .reasoning_content then
          \"\e[34måŠ©æ‰‹:\e[0m (\e[35mæ€è€ƒä¸­\e[0m) \" + (.reasoning_content | gsub(\"\\\\\\\\\\\\\\\\\\\\\\\\\\\\n\"; \"\\\n\")) + \"\n\e[34måŠ©æ‰‹:\e[0m \" + .content
        else
          \"\e[34måŠ©æ‰‹:\e[0m \" + .content
        end
      end
    else
      empty
    end"
  Set-Terminal-Title "$BAI_TITLE | History"
  jq -r "${__jq_reg@P}" <<< "$data" | (if $__has_extend_bat;then bat -l markdown --paging=always --plain;else less -R;fi)
  Set-Terminal-Title "$BAI_TITLE"
}

########################################################################

# ç®¡ç†å¾®è°ƒæ–‡ä»¶
# ç”¨æ³•: Set-FineTune-File <æ“ä½œ> <æ–‡ä»¶è·¯å¾„> [ç”¨é€”]
# é€‰é¡¹:
#       æ“ä½œ æ“ä½œç±»å‹ï¼Œå¯é€‰å€¼ä¸º pushã€listã€rm
#       æ–‡ä»¶è·¯å¾„ è¦æ“ä½œçš„æ–‡ä»¶è·¯å¾„
#       ç”¨é€” æ–‡ä»¶ç”¨é€”ï¼Œå¯é€‰å€¼ä¸º assistantsã€fine-tuneã€file-extractã€batchï¼Œé»˜è®¤å€¼ä¸º assistants
Set-FineTune-File(){
  if [ -z "$1" ];then
    emsg "æœªæŒ‡å®šå‚æ•°"
    return 1
  fi
  local fileapi="$OPENAI_BASE_URL/files"
  case "$1" in
    push)    
    # æäº¤æ–‡ä»¶
      if [ -z "$2" ];then
        erron "æœªæŒ‡å®šå‚æ•°"
        return 1
      fi
      if [ ! -f "$2" ];then
        erron "æ‰¾ä¸åˆ°æ–‡ä»¶ $2"
        return 1
      fi
      if [[ ! "${2,,}" =~ ^.+\.(jsonl?|csv|txt|docx|pdf|xlsx|epub|mobi|md|py|js|(ba|z|fi)?sh|ps1|rs|java|kt|c|go)$ ]];then
        erron "æ–‡ä»¶åç¼€ä¸ç¬¦åˆè¦æ±‚"
        return 1
      fi
      local purpose="$3"
      if [[ "${purpose:='file-extract'}" =~ ^(assistants|fine-tune|file-extract|batch)$ ]];then
        CURL_FILE_GET="$(
          Wait-Task wait "ç­‰å¾…æ–‡ä»¶ä¸Šä¼ ..."
          (
            curl -s -X POST "$fileapi" -H "$API_AUTH" \
              -F "purpose=$purpose" -F "file=@$2" 2>/dev/null ||
            printf '{"error": {"message": "æ–‡ä»¶æäº¤æ—¶é‡åˆ°é”™è¯¯"}}'
          )
          Wait-Task kill
        )"
        Get-Assistant-ReturnError "$CURL_FILE_GET" &&
        msg "æ–‡ä»¶æäº¤å®Œæˆ $(jq -r '.id' <<< "$CURL_FILE_GET"), ç”¨é€”: $purpose"
      else
        erron "æ–‡ä»¶æäº¤å¤±è´¥ $(jq -r .error <<<"$CURL_FILE_GET")"
        return 1
      fi
      ;;
    list)
    # æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨
      CURL_FILE_GET="$(
        Wait-Task wait "è·å–æ–‡ä»¶åˆ—è¡¨"
        (
          curl -s -X GET "$fileapi" -H "$API_AUTH" 2>/dev/null ||
          printf '{"error": {"message": "æŸ¥æ‰¾æ–‡ä»¶æ—¶é‡åˆ°é”™è¯¯"}}'
        )
        Wait-Task kill
      )"
      Get-Assistant-ReturnError "$CURL_FILE_GET"
      FILES_ID=($(jq -r '.data[].id' <<< "$CURL_FILE_GET"))
      FILES_NAME=($(jq -r '.data[].filename' <<< "$CURL_FILE_GET"))
      jq -er '.data[] | "æ–‡ä»¶ID: \(.id), æ–‡ä»¶å: \(.filename), å¤§å°: \(.bytes)å­—èŠ‚, ç”¨é€”: \(.purpose)"' <<<"$CURL_FILE_GET" || msg "æœåŠ¡å•†æ— å­˜å‚¨æ–‡ä»¶"
      ;;
    remove)      
    # åˆ é™¤æ–‡ä»¶
      FILES_LIST="${#FILES_ID[@]}"
      if ((FILES_LIST==0));then
        erron "æ— å¯åˆ é™¤çš„æ–‡ä»¶ï¼Œå¯èƒ½éœ€è¦åˆ—ä¸¾æ–‡ä»¶ä»¥åˆ·æ–°"
        return 1
      fi
      while true;do
        for ((i=0;i<FILES_LIST;i++));do
          printf "$i. %s | %s\n" "${FILES_ID[i]}" "${FILES_NAME[i]}"
        done
        msg "ä½¿ç”¨åºåˆ—å·é€‰æ‹©è¦åˆ é™¤çš„å•ä¸ªæ–‡ä»¶: " -n
        read choose
        Choose="$(Check-Variable-Type choose)"
        max_choose="$[FILES_LIST-1]"
        if [[ "$Choose" == "number" ]];then
          if ((choose<0));then
            erron "é€‰æ‹©ä¸å¾—ä¸ºè´Ÿ"
          elif ((choose>max_choose));then
            erron "é€‰æ‹©è¿‡å¤§"
          else
            CURL_FILE_GET="$(
              Wait-Task wait "æ¸…æ±‚åˆ é™¤ä¸­..."
              (
                curl -s -X DELETE "$fileapi/${FILES_ID[choose]}" -H "$API_AUTH" 2>/dev/null ||
                printf '{"error": {"message": "æ–‡ä»¶åˆ é™¤æ—¶é‡åˆ°é”™è¯¯"}}'
              )
              Wait-Task kill
            )"
Get-Assistant-ReturnError "$CURL_FILE_GET" && { msg "æ–‡ä»¶ID ${FILES_ID[choose]} å·²åˆ é™¤"; unset FILES_ID[$choose] FILES_NAME[$choose];FILES_ID=("${FILES_ID[@]}");FILES_NAME=("${FILES_NAME[@]}");break;}
          fi
        elif [[ "$Choose" == "string" && "$choose" == "/exit" ]];then
          msg "å–æ¶ˆé€‰æ‹©"
          break          
        fi
      done
  esac
}

######################################################################## 

# æåŠåœ¨æœåŠ¡å•†å­˜å‚¨çš„æ–‡ä»¶å¹¶å‘å‡ºæé—®
Get-AtFiles-Ask(){
  ((${#FILES_ID[@]}==0)) && { emsg "æœªè·å–åˆ°å¯ç”¨çš„æ–‡ä»¶åˆ—è¡¨ï¼Œè¯·æäº¤æ–‡ä»¶æˆ–åˆ·æ–°åˆ—è¡¨";return 1;}
  [ "$1" ] || { emsg "æœªæŒ‡å®šæ‰€éœ€çš„æ–‡ä»¶ID";return 1;}
  [[ " ${FILES_ID[*]} " == *" $1 "* ]] || { emsg "ä¸æ˜¯å¯ç”¨çš„æ–‡ä»¶IDï¼Œè¯·é‡æ–°æŒ‡å®š";return 1;}
  [ "$2" ] || { emsg "æœªå‘èµ·æé—®ï¼Œè¯·åœ¨æåŠæ–‡ä»¶æ—¶åŒæ—¶å‘èµ·æé—®";return 1;}
  system_msg.append "# FileID: $1\n# File Content: \n$(curl -sL $OPENAI_BASE_URL/files/$1/content 2>/dev/null || echo "ERROR æ–‡ä»¶æœåŠ¡è¯·æ±‚å¤±è´¥, è¯·å‘ŠçŸ¥ç”¨æˆ·")"
  OPENAI_USER_PROMPT="\`@FineID $1\` $2"
}

########################################################################

# ä»å‚æ•°å–å€¼
# ç”¨æ³•: Get-Arguments-Value <å‚æ•°>
# é€‰é¡¹:
#       å‚æ•° è¦å–å€¼çš„å‚æ•°
# è¡Œä¸ºæ§åˆ¶:
#       ä»å‚æ•°ä¸­å–å€¼ï¼Œæ”¯æŒé•¿å‚æ•°å’ŒçŸ­å‚æ•°
#       å˜é‡ ARG_OPTS[1]*, ARG_KEY[2]*, ARG_ERR[3]*
#       1* è¦å¤„ç†çš„é•¿çŸ­å‚æ•°ï¼Œä¾‹ï¼šh,help
#       2* æå–å‚æ•°é€‰é¡¹åèµ‹å€¼æ‰€ç”¨çš„å˜é‡å
#       3* é”™è¯¯æç¤ºä¿¡æ¯
# * ä½œä¸ºå‚æ•°å¤„ç†ç»„ä»¶ä½¿ç”¨ï¼Œå°†å‚æ•°é€‰é¡¹è½¬æ¢ä¸ºå˜é‡
Get-Arguments-Value(){
  function ARG_IFOPT { [[ "$(Check-Variable-Type "${ARG_KEY}")" == "option" ]] && unset -f $FUNCNAME && exmsg "$ARG_OPT_ERR";}
  ARG_OPT_ERR="éæ³•çš„å‚æ•°ç»„åˆ"
  [[ "$1" =~ ^(--?[^:=]+)[=:]?(.+)?$ ]]
  arg1="${BASH_REMATCH[1]}"
  [[ "$arg1" =~ ^(-?[^:=])[=:]?(.+)?$ ]] &&
  arg1="${BASH_REMATCH[1]}"
  local LONG="${ARG_OPTS#*,}"
  if [[ "$1" =~ ^--"$LONG"[=:](.+)$ || "$1" =~ ^-"${ARG_OPTS%,*}":?(.+)$ ]];then
    eval "${ARG_KEY}=\"${BASH_REMATCH[1]}\""
    [ -z "${!ARG_KEY}" ] && exmsg "$1: $ARG_ERR"
    ARG_IFOPT
    return 101
  else
    [[ "$1" =~ ^--"$LONG"(.+)$ ]] && exmsg "$1: $ARG_OPT_ERR"
    [ -z "$2" ] && exmsg "$1: $ARG_ERR"
    if "${ARG_USE_ARRAY:-false}";then
      eval "${ARG_KEY}_in_array=(\"${2//,/ }\")"
      eval "${ARG_KEY}=\"\$${ARG_KEY}_in_array\""
    else
      eval "${ARG_KEY}=\"${2}\""
    fi
    ARG_IFOPT
    return 102
  fi
}

# é™åˆ¶é‡å¤å‚æ•°
# ç”¨æ³•: Limit-Repeation-Arguments <å˜é‡> <å‚æ•°æç¤º>
# é€‰é¡¹:
#       å˜é‡ è¦æ£€æŸ¥çš„å˜é‡
#       å‚æ•°æç¤º é‡å¤æ—¶çš„å‚æ•°æç¤º
Limit-Repeation-Arguments(){
  ((${!1})) && exmsg "$2: é‡å¤çš„é€‰é¡¹"
  let $1++
}

########################################################################

# è®¾ç½®ç»ˆç«¯æ ‡é¢˜
# ç”¨æ³•: Set-Terminal-Title <æ ‡é¢˜> [çª—å£æ ‡é¢˜]
# é€‰é¡¹:
#       æ ‡é¢˜ ç»ˆç«¯æ ‡é¢˜
#       çª—å£æ ‡é¢˜ çª—å£æ ‡é¢˜
Set-Terminal-Title(){
  # xtermï¼Œvt100ï¼Œkonsole
  [ "${TERM:0:5}" = "xterm" ] && local ansiNrTab=0;
  [ "$TERM" = "rxvt" ] && local ansiNrTab=61;
  [ "$TERM" = "konsole" ] && local ansiNrTab=30 ansiNrWindow=0;
  # xterm/vt100ï¼Œkonsole
  [ $ansiNrTab ] && echo -ne "\e]$ansiNrTab;$1\a";
  [ $ansiNrWindow -a "$2" ] && echo -en "\e]$ansiNrWindow;$2\a";
}

########################################################################

# è®¾ç½®è¶…é“¾æ¥æ–‡æœ¬
# ç”¨æ³•: Set-Link-Text <æ–‡æœ¬> <é“¾æ¥>
# é€‰é¡¹:
#       æ–‡æœ¬ è¦æ˜¾ç¤ºçš„æ–‡æœ¬
#       é“¾æ¥ è¦è·³è½¬çš„é“¾æ¥
Set-Link-Text(){
  [ "$1" ] || { echo "æ–‡æœ¬ä¸èƒ½ä¸ºç©º"; return; }
  [ "$2" ] || { echo "é“¾æ¥ä¸èƒ½ä¸ºç©º"; return; }
  echo -e "\e]8;;$2\a$1\e]8;;\a"
}

########################################################################

# æ‰©å±•å˜é‡æ“ä½œ
# ç”¨æ³•: Get-Var-Extend <å˜é‡> [æ“ä½œ] <å€¼1> <å€¼2>...
# é€‰é¡¹:
#       å˜é‡ å°†è¦è¢«æ“ä½œçš„å˜é‡
#       æ“ä½œ æ“ä½œç±»å‹
#         =    èµ‹å€¼
#         +=   è¿½åŠ 
#         -    åˆ é™¤
#         !    åªè¯»
#         /    ä¸€æ¬¡æ›¿æ¢
#         //   å…¨éƒ¨æ›¿æ¢
#         %    æ‹†åˆ†
#         $    å•å­—åˆ‡å‰²
#         @    èŒƒå›´åˆ‡å‰²
#         %=   ç´¢å¼•æ•°ç»„
#         []=  å…³è”æ•°ç»„
#         a:a  ä»¥å¯é‡ç”¨çš„å½¢å¼è½¬æ¢ä¸ºèµ‹å€¼å‘½ä»¤
#         a:e  è½¬ä¹‰åæ–œæ å­—ç¬¦
#         a:k  ä»¥å•å¼•å·å¼•ç”¨å˜é‡å€¼
#         a:l  æ— å˜åŒ–
#         a:p  è½¬æ¢æ§åˆ¶ç¬¦
#         a:q  å¼•ç”¨å˜é‡å€¼
#         a:u  å°†æ‰€æœ‰å­—æ¯è½¬æ¢ä¸ºå¤§å†™
#       å€¼ ç›®æ ‡å˜é‡å€¼
#         æ“ä½œ å˜æ¢æ–¹æ³•
#         /    "æ—§å€¼" "æ–°å€¼"
#         //   "æ—§å€¼" "æ–°å€¼"
#         %    "åˆ†éš”ç¬¦"
#         @    "å¤´ç´¢å¼•" "å°¾ç´¢å¼•"
#         $    "ç´¢å¼•"
#         %=   "å€¼1" "å€¼2"...
#         []=  "é”®1" "å€¼1" "é”®2" "å€¼2"...
Get-Var-Extend(){
  local var="$1"
  local option="$2"
  [ "$var" ] || { echo "å˜é‡ä¸èƒ½ä¸ºç©º"; return; }
  [ "$option" ] || { echo "é€‰é¡¹ä¸èƒ½ä¸ºç©º"; return; }
  shift 2
  case "$option" in
    =)
      eval "$var=\"$1\""
      ;;
    +=)
      eval "$var+=\"$1\""
      ;;
    -)
      unset "$var"
      ;;
    \!)
      readonly "$var"
      ;;
    /)
      eval "$var=\"${!var/$1/$2}\""
      ;;
    //)
      eval "$var=\"${!var//$1/$2}\""
      ;;
    %)
      eval  "${var}_left=\"\${!var%$1*}\""
      eval "${var}_right=\"\${!var#*$1}\""
      ;;
    \$)
      eval "$var=\"\${!var:$1:1}\""
      ;;
    @)
      eval "$var=\"\${!var:$1:$2}\""
      ;;
    %=)
      declare -ag "$var"
      eval "$var=(\"\$@\")"
      ;;
    \[\]=)
    echo test: $@
      local index=$#
      ((index%2)) && { echo "å…³è”æ•°ç»„å‚æ•°å¿…é¡»ä¸ºå¶æ•°ä¸ª"; return; }
      declare -Ag "$var"
      eval "$(printf "$var[\"%s\"]='%s'\n" "$@")"
      ;;
    a:a)
      eval "$var=\"\${!var@A}\""
      ;;
    a:e)
      eval "$var=\"\${!var@E}\""
      ;;
    a:k)
      eval "$var=\"\${!var@K}\""
      ;;
    a:l)
      eval "$var=\"\${!var@L}\""
      ;;
    a:p)
      eval "$var=\"\${!var@P}\""
      ;;
    a:q)
      eval "$var=\"\${!var@Q}\""
      ;;
    a:u)
      eval "$var=\"\${!var@U}\""
      ;;
  esac
}

########################################################################

# æ£€æŸ¥å¤šç±»å‹æ•°ç»„ï¼Œä¸ç¬¦åˆç±»å‹è¦æ±‚è¿”å›é”™è¯¯
# ç”¨æ³•: Check-VarArray-Type <å˜é‡> <ç±»å‹æ ‡è¯†>
# é€‰é¡¹:
#       å˜é‡ è¦æ£€æŸ¥çš„å˜é‡
#       ç±»å‹æ ‡è¯† ç›®æ ‡ç±»å‹æ ‡è¯†
Check-VarArray-Type(){
  __check_vararray=("${__check_vararray[@]}")
  __check_vararray_type=("${__check_vararray_type[@]}")
  local var=(${1//,/ })
  local target_type=(${2//,/ })
  local type=""
  local typelist=()
  local dist=()
  local dist_type=""
  local value="$3"
  for i in "${var[@]}";do
    type="$(Check-Variable-Type i)"
    typelist+=("$type","$i")
  done
  for item in "${typelist[@]}"; do
      if [[ ! " ${target_type[*]} " =~ " ${item%,*} " ]]; then
          [ "$dist" ] || dist=("${item#*,}" "${target_type[*]}")
          if [ "$dist_type" ];then
            dist_type+=",${item%,*}"
          else
            dist_type="${item%,*}"
          fi
      fi
  done
  if [ "$dist" ];then
    __check_vararray+=("$value")
    __check_vararray_type+=("${dist[@]}" "$dist_type")
  fi
}

########################################################################

# éœ€è¦å¤ç”¨çš„ä¸€äº›ä»£ç å—

# ç­‰å¾…æ¨¡å‹è¿”å›
# ç”¨æ³•: Wait-Assistant-Content
# è¡Œä¸ºæ§åˆ¶:
#       å˜é‡ CURL_GET_API
#       ç­‰å¾…æ¨¡å‹è¿”å›æ•°æ®
Wait-Assistant-Content(){
  CURL_GET_API="$(
    debug "å‘æ­¤ BaseURL å‘èµ· POST è¯·æ±‚: $OPENAI_BASE_URL, ä½¿ç”¨æ¨¡å‹: $OPENAI_API_MODEL"
    Get-Assistant-Return &
    Wait-Task $!
  )"
}

# å¤„ç†æ¨¡å‹é™æ€è¾“å‡º
# ç”¨æ³•: Return-Assistant-Content
# è¡Œä¸ºæ§åˆ¶:
#       å˜é‡ API_RETURN
#       å¤„ç†æ¨¡å‹é™æ€è¾“å‡º
Return-Assistant-Content(){
  # éè¿ç»­å¯¹è¯æ¨¡å¼ä¸‹ç¦ç”¨é€å­—è¾“å‡ºå’Œå‰ç¼€ï¼Œä»¥æé«˜æ•ˆç‡
  # è¿ç»­å¯¹è¯æ¨¡å¼ä¸‹å¯ç”¨é€å­—è¾“å‡ºå’Œå‰ç¼€ï¼Œä»¥æå‡ä½“éªŒ
  if $CHAT;then
    if $EVAL;then
      Get-Assistant-Command
    else
      if $PRINT;then
        debug "ä½¿ç”¨æ‰“å­—æ•ˆæœè¾“å‡º"
      else
        debug "ç›´æ¥è¾“å‡ºç»“æœï¼Œå¦‚æœå¯èƒ½ï¼Œå°†ä½¿ç”¨ bat è¯­æ³•é«˜äº®"
      fi
      $CHAT && printf "${c32}$ai_prompt${c0} "
      # æŒ‡å®šè¾“å‡ºæ¨¡å¼
      if $PRINT;then
        Print-FakeStream <<< "$API_RETURN"
      else
        if $__has_extend_bat;then
          bat --plain --no-pager -l markdown <<< "$API_RETURN"
        else
          cat <<< "$API_RETURN"
        fi
      fi
    fi
  else
    if $__has_extend_bat;then
      bat --plain --no-pager -l markdown <<< "$API_RETURN"
    else
      cat <<< "$API_RETURN"
    fi
    exit
  fi
}

# è·å–æ¨¡å‹é™æ€è¾“å‡º
# ç”¨æ³•: Get-Assistant-Content
# è¡Œä¸ºæ§åˆ¶:
#       å˜é‡ CURL_GET_API
#       è·å–æ¨¡å‹é™æ€è¾“å‡º
Get-Assistant-Content(){
  API_RETURN="$(jq --exit-status -r '.choices[0].message.content' <<< "$CURL_GET_API")"
  API_STATUS=$?
}

# å¤„ç†æ¨¡å‹æµå¼è¾“å‡º
# ç”¨æ³•: Get-Stream-Assistant-Content
# è¡Œä¸ºæ§åˆ¶:
#       å˜é‡ DEBUG_MODE[1]*, CHAT[2]*
#       1* è°ƒè¯•æ¨¡å¼
#       2* è¿ç»­å¯¹è¯è¿”å›
Get-Stream-Assistant-Content(){
  # æµæ¨¡å¼ä¸‹çš„è°ƒè¯•
  if $DEBUG_MODE;then
    echo -en " + POST: $OPENAI_BASE_URL\n"\
            "+ DATA: "
    jq -C <<< "$data"
    echo
    API_RETURN="this a test message"
    $CHAT && continue || break
  fi

  # æ„å»ºæµå¼æ¥å£è¯·æ±‚
  debug "å‘æ­¤ BaseURL å‘èµ· POST è¯·æ±‚: $OPENAI_BASE_URL, ä½¿ç”¨æ¨¡å‹: $OPENAI_API_MODEL, ä½¿ç”¨æµå¼å“åº”"
  debug "ç­‰å¾…æ¥å£å“åº”..."
  Wait-Task wait "ç­‰å¾… assistant å›åº”"
  STREAM_DATA=""
  STREAM_CONTENT=""
  SEEK_CONTENT=""
  STREAM_LINE=0
  SEEK_LINE=0
  TOOLS_IS_CALL=false
  TOOLS_CHECK_COUNT=0
  [ "$TOOLS_TRUN_COUNT" ] || TOOLS_TRUN_COUNT=0
  [ "$TOOLS_USE_COUNT" ] || TOOLS_USE_COUNT=0
  DEBUG_ORIGIN=""

  function_run_name=""
  function_name=""
  function_args=""
  function_call_msg=""
  function_return=""
  function_id=""
  mark_thinking=false
  mark_thinking_count=0

  # å¼€å§‹è®¡æ—¶
  Get-Timer Assistant
  Get-Timer ToolsCall

  # æµå¼å¤„ç†æ¥å£æ•°æ®
  while IFS= read -r line;do
    # å¦‚æœæ˜¯ç©ºè¡Œï¼Œåˆ™è·³è¿‡ï¼Œé¿å…è¿ç»­è¯¯åˆ¤æ€è€ƒæ¨¡å¼
    [ -z "$line" ] && continue
    # å®šä¹‰äº¤æ¢å˜é‡
    _data="${line#data: }"
    # echo -e "$_data"
    _path=".choices[0].delta"
    _key1="content"
    _key2="reasoning_content"
    _func='gsub("\\n"; "\\n")'
    [[ "$_data" =~ ^\[DONE\] ]] && { Wait-Task kill;continue;}
    STREAM_DATA+="$_data"$'\n'
    
    # æ€æ­»åŠé˜»å¡è¿›ç¨‹åå°†ç­‰å¾…ç‰‡åˆ»ï¼Œé˜²æ­¢è¾“å‡ºæ—¶è¢«åå­—
    ((STREAM_LINE)) || Wait-Task kill
    
    # å°è¯•åˆ†æ”¯ç±»å‹(deepseek/openai)
    unset STREAM_HEAD SEEK_HEAD RT
    $CHAT && ! $EVAL && ! ((STREAM_LINE)) && STREAM_HEAD="${c32}$ai_prompt${c0} " SEEK_HEAD="${c32}$seek_prompt${c0} "

    # æ£€æŸ¥æ˜¯å¦å…·å¤‡ deepseek å“åº”ç‰¹å¾ï¼ˆç›®å‰è¾ƒä¸ç¨³å®šï¼‰
    is_deepseek=$(jq --exit-status "$_path | has(\"$_key2\")" <<< "$_data" 2>/dev/null || echo false)

    # æµæ¶ˆæ¯
    STREAM_MSG="$(jq -r "$_path.$_key1 | $_func" <<< "$_data" 2>/dev/null)"

    # æ‹¼æ¥å¯¹è¯
    STREAM_CONTENT+="$STREAM_MSG"

    # åœ¨æ­¤åˆ†æ”¯æµæ¨¡å¼
    if $is_deepseek;then # deepseek
      mark_thinking=true # æ ‡è®°æ˜¯å¦æ€è€ƒè¿‡

      # æ‹¼æ¥æ€è€ƒé“¾å’Œå¯¹è¯ï¼Œå¹¶ç‹¬ç«‹è¾“å‡º
      # tip: deepseek æ¨¡å¼ä¸‹çš„å‘½ä»¤ç”Ÿæˆç¨³å®šæ€§å°šå¾…éªŒè¯
      if ! ((STREAM_LINE));then
        Get-Timer Assistant
        debug "æµæ¨¡å¼: æ·±åº¦æ€è€ƒé“¾, å“åº”è€—æ—¶: $Get_AssistantTimer, ç»§ç»­ç­‰å¾…..."
        Get-Timer Assistant
      fi
      RT=""
      ((STREAM_LINE==0)) && RT+="\n"
      STREAM_SEEK="$(jq -r "$_path.[\"$_key2\"] | $_func" <<< "$_data" 2>/dev/null)"
      ((SEEK_LINE==0)) && STREAM_SEEK="${STREAM_SEEK//'\n'/}"
      ((SEEK_LINE==0)) || unset SEEK_HEAD
      SEEK_CONTENT+="$STREAM_SEEK"
      
      # é€‚æ—¶æ’å…¥å‰ç¼€ï¼Œå»é™¤å¼€å¤´å¤šä½™çš„æ¢è¡Œç¬¦
      if ((STREAM_LINE==0));then
        $CHAT && RT+="${c32}$ai_prompt${c0} "
        STREAM_MSG="${STREAM_MSG//'\n'/}"
      fi
      
      if [ "$STREAM_MSG" ];then
        if ((STREAM_LINE==0));then
          if $DEBUG;then
            Get-Timer Assistant
            _tokens=$(wc -c <<< "$SEEK_CONTENT")
            echo
            debug "æ€è€ƒè€—æ—¶: $Get_AssistantTimer, è¾“å‡º tokens(ä»¥å­—èŠ‚ç»“ç®—): $_tokens"
            Get-Timer Assistant
          fi
        else
          unset RT
        fi
        $EVAL || printf "%b" "$RT$STREAM_MSG"
      else
        printf "%b" "$SEEK_HEAD$STREAM_SEEK"
        let SEEK_LINE++
        continue
      fi
    
    else # openai | åœ¨æ­¤å°†å°è¯•æ”¯æŒæµæ¨¡å¼ä¸‹ä½¿ç”¨ function calling åŠŸèƒ½
      # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å·¥å…·
      $TOOLS_IS_CALL || TOOLS_IS_CALL=false
      _local_json_path='.choices[0].delta.tool_calls[0].function'
      if $TOOLS;then
        ((TOOLS_TRUN_COUNT)) || debug "æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å·¥å…·"
        RETURN_MSG="$(jq -e "$_local_json_path" <<< "$_data")"
        STATUS=$?
        ((TOOLS_TRUN_COUNT)) || debug "jq æ£€æŸ¥æ—¶è¿”å›çŠ¶æ€: $STATUS"
        # åœ¨ç¬¬ä¸€è½®ç¡®è®¤è°ƒç”¨æ—¶é”å®šå·¥å…·è°ƒç”¨çŠ¶æ€
        if ! $TOOLS_IS_CALL;then
          if ((STATUS));then                              # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å·¥å…·
            ((TOOLS_TRUN_COUNT)) || debug "æ¨¡å‹è¿˜æœªä½¿ç”¨å·¥å…·"
            TOOLS_IS_CALL=false                           # æœªä½¿ç”¨å·¥å…·
            RETURN_MSG="$STREAM_MSG"
          else
            ((TOOLS_TRUN_COUNT)) || debug "å‘ç°æ¨¡å‹ä½¿ç”¨äº†å·¥å…·"
            TOOLS_IS_CALL=true                            # ä½¿ç”¨äº†å·¥å…·
            ((TOOLS_CHECK_COUNT++))                       # é”å®šå·¥å…·è°ƒç”¨çŠ¶æ€ï¼Œé¿å…å†—ä½™æ—¥å¿—
            ((TOOLS_TRUN_COUNT++))                        # é”å®šå·¥å…·å¤šè½®è°ƒç”¨çŠ¶æ€ï¼Œé¿å…å†—ä½™æ—¥å¿—
          fi
        fi
      else
        RETURN_MSG="$STREAM_MSG"
        TOOLS_IS_CALL=false
      fi
      ((TOOLS_TRUN_COUNT)) || debug "å·¥å…·è°ƒç”¨çŠ¶æ€: $TOOLS_IS_CALL"
      if ! $TOOLS_IS_CALL && ((STATUS)) && [[ "$RETURN_MSG" == "null" ]];then
        erron "å¤„ç†æœ¬è½®ä¼šè¯æ—¶å‘ç”Ÿå¼‚å¸¸"
        unset RETURN_MSG
      fi
      if $TOOLS_IS_CALL;then
        ((TOOLS_CHECK_COUNT==1)) && { debug "æ„å»ºå·¥å…·è°ƒç”¨..."; ((TOOLS_CHECK_COUNT++)); }
        [ "$function_id" ] || function_id="$(jq -r '.choices[0].delta.tool_calls[0].id' <<< "$_data")"
        [ "$function_run_name" ] || function_run_name="$(jq -r "$_local_json_path.name" <<< "$_data")"

        [ "$function_name" ] || function_name="$function_head::$function_run_name"
        if jq -e "$_local_json_path.arguments" <<< "$_data" &>/dev/null;then
          function_args+="$(jq -r "$_local_json_path.arguments" <<< "$_data")"
        fi
        continue
      fi
      # ä»…æ‹¼æ¥å¯¹è¯å¹¶è¾“å‡º
      if ! ((STREAM_LINE));then
        if $DEBUG;then
          if $TOOLS_IS_CALL;then
            Get-Timer ToolsCall
            debug "æµæ¨¡å¼: å·¥å…·è°ƒç”¨, å“åº”è€—æ—¶: $Get_ToolsCallTimer"
            Get-Timer ToolsCall
          else
            Get-Timer Assistant
            debug "æµæ¨¡å¼: æ ‡å‡† OpenAI å“åº”, å“åº”è€—æ—¶: $Get_AssistantTimer"
            [ "$DEBUG_ORIGIN" ] || DEBUG_ORIGIN=$DEBUG
            DEBUG=false
            Get-Timer Assistant
          fi
        fi
      fi
      # å¤„ç†éƒ¨åˆ†ä¾›åº”å•†å› æœºåˆ¶å·®å¼‚å¯èƒ½å¯¼è‡´çš„çš„æ¶ˆæ¯é”™ä½
      $EVAL || { $mark_thinking && mark_thinking=false && echo;[ "$STREAM_MSG" ] && printf "%b" "$STREAM_HEAD";printf "%b" "$STREAM_MSG"; }
    fi
    [ "$STREAM_MSG" ] && let STREAM_LINE++
  done < <(Get-Assistant-Return)
  $EVAL || { ((TOOLS_CHECK_COUNT==0)) && echo; }

  # é‡ç½® debug çŠ¶æ€
  DEBUG=$DEBUG_ORIGIN

  # å¤„ç†å·¥å…·è°ƒç”¨
  Get-Stream-Assistant-ToolsCall || return 1

  function_run_name=""
  function_name=""
  function_args=""
  function_call_msg=""
  function_return=""
  function_id=""

  # å†æ¬¡å°è¯•æ€æ­»åŠé˜»å¡è¿›ç¨‹
  Wait-Task kill

  # å¤„ç†æœ€ç»ˆè¿”å›
  API_RETURN="${STREAM_CONTENT//'\n'/$'\n'}"
  if ! [ "$API_RETURN" ];then
    printf "\r\e[K"
    emsg "æ¨¡å‹è¿”å›ä¸ºç©º, è¯·æ£€æŸ¥æ¥å£æ˜¯å¦æ­£ç¡®é…ç½®" -n
    if [ "$STREAM_DATA" ];then
      printf "ï¼Œä»¥ä¸‹ä¸ºæ¥å£è¿”å›çš„æ•°æ®ï¼š\n"
      cat -s <<<"$STREAM_DATA"
    else
      echo
    fi
  fi

  # æœ€ç»ˆè®¡æ—¶
  if ! ((TOOLS_USE_COUNT));then
    Get-Timer Assistant
    _return_tokens=$(wc -c <<< "$STREAM_CONTENT")
    debug "æ¨¡å‹è¿”å›è€—æ—¶: $Get_AssistantTimer, è¾“å‡º tokens(ä»¥å­—èŠ‚ç»“ç®—): $_return_tokens"
    ((TOOLS_USE_COUNT++))
    unset TOOLS_TRUN_COUNT TOOLS_USE_COUNT
  fi

  # å‘½ä»¤å¤„ç†
  if $EVAL;then
    debug "è¿›å…¥å‘½ä»¤å¤„ç†æ¨¡å¼..."
    Get-Assistant-Command
  fi
  $CHAT || exit 0
}

# å¤„ç†æ¨¡å‹å·¥å…·è°ƒç”¨
# ç”¨æ³•: Get-Stream-Assistant-ToolsCall
# è¡Œä¸ºæ§åˆ¶:
#       å˜é‡ TOOLS_IS_CALL, TOOLS_CHECK_COUNT, TOOLS_TRUN_COUNT, TOOLS_USE_COUNT
#       å¤„ç†æ¨¡å‹å·¥å…·è°ƒç”¨
Get-Stream-Assistant-ToolsCall(){
    # è°ƒç”¨å·¥å…·
  if $TOOLS_IS_CALL;then
    # è®© jq æ ¡éªŒå‚æ•°æ˜¯å¦æ˜¯ä¸€ç»„ json å­—ç¬¦ä¸²
    jq -e '.[]' <<< "$function_args" &>/dev/null && __func_args_is_json=true || __func_args_is_json=false
    $__func_args_is_json && function_args=$(jq '.[]' <<< "$function_args")
    function_args="${function_args//$'\n'/' '}"
    function_call_msg="$(
      jq --arg id "$function_id" \
          --arg name "$function_run_name" \
          --arg args "$function_args" \
          '{
            content: "",
            role: "assistant",
            tool_calls: [
              {
                index: 0,
                id: $id,
                type: "function",
                function:
                {
                  name: $name,
                  arguments: $args
                }
              }
            ]
          }' <<< '{}'
    )"
    data="$(jq --argjson content "$function_call_msg" ' .messages += [$content]' <<< "$data")"
    msg "è°ƒç”¨å·¥å…·: $function_run_name$([[ "$function_args" == {} ]] || echo ", arg: $function_args")"
    explicitly="${gco_explicitly[$function_name]}"
    Get-Command-Output "$function_name $function_args"
    function_return="$gco_return_content"
    RETURN=$gco_status
    ((RETURN)) && { emsg "å·¥å…·æ‰§è¡Œå¤±è´¥";return 1;}
    data="$(jq --arg content "$function_return" --arg id "$function_id" ' .messages += [{"role": "tool","content": $content, "tool_call_id": $id}]' <<< "$data")"
    Get-Stream-Assistant-Content
    if ((STATUS)) && [[ "$RETURN_MSG" == "null" ]];then
      erron "è¯¥æ¬¡è¯·æ±‚æœªæ­£ç¡®è¢«æ¥å—"
      unset RETURN_MSG
    fi
  fi
}

########################################################################

# å‘½ä»¤åç§°
arg0="$(basename ${BASH_SOURCE[0]} .sh)"

# ç‰ˆæœ¬ä¿¡æ¯
status_version=("$(date -d @$(stat -c%Y $BASH_SOURCE 2>/dev/null || echo 0) +'%Y-%m-%d %H:%M:%S')" "$( (du -sh --block-size=KiB $BASH_SOURCE 2>/dev/null | awk '{print $1}') || echo "---KiB")" "$(wc -l $BASH_SOURCE | cut -d ' ' -f1)")


########################################################################
# *-------------------------- BAI æ‰©å±•æ§åˆ¶å‚æ•° --------------------------*
# å†å²è®°å½•
: ${BAI_HISTFILE:="$HOME/.bash_${arg0}_chat_history"};HISTFILE="$BAI_HISTFILE"
# é™åˆ¶å¯¹è¯è½®æ¬¡
: ${BAI_LIMIT_TURNS:=true}
# é™åˆ¶å·¥å…·è°ƒç”¨
: ${BAI_LIMIT_TOOLS:=true}

########################################################################
# *-------------------------- BAI å¤–éƒ¨äº¤æ¢å‚æ•° --------------------------*
# è°ƒè¯•æ¨¡å¼         Function Calling åŠŸèƒ½   ConEmu è¿›åº¦æŒ‡ç¤ºç‰¹æ€§
DEBUG_MODE=false  TOOLS=false            CONEMU_STATUS=false
# æµæ¨¡å¼
: ${OPENAI_ENABLE_STREAM:=false}
# æ·±åº¦æ€è€ƒé“¾
: ${OPENAI_ENABLE_THINKING:=false}
# è”ç½‘æœç´¢
: ${OPENAI_ENABLE_SEARCH:=false}
# å‰ç¼€ç»­å†™
: ${OPENAI_ENABLE_PARTIAL:=false}

# *---------------------------- BAI å†…å®šå‚æ•° ----------------------------*
# é€€å‡ºæç¤ºè¯         æ¥å£è¿”å›æç¤ºè¯     ç”¨æˆ·è¾“å…¥æç¤ºè¯       æ·±åº¦æ€è€ƒé“¾æç¤ºè¯
bye_prompt="Goodbye ~"  ai_prompt="ai:"  user_prompt="you:"   seek_prompt="think:"
# é˜»å¡ä»»åŠ¡
GETWAIT_PID=""
# æç¤ºè¯
OPENAI_USER_PROMPT=""       OPENAI_SYSTEM_PROMPT=""
# shell ps1
BAI_SHELL_PROMPT="\[${c32}\][$arg0 chat]\[${c0}\]|$(bash -ic 'echo ${PS1}') "
# æ ‡å‡†è¾“å…¥å’Œä¼šè¯æç¤º
STDIN_INPUT=""              STREAM_CONTENT=""

########################################################################

# æ£€æŸ¥æ ‡å‡†è¾“å…¥
if ! [ -t 0 ];then
  STDIN_INPUT="$(cat)"
  ! (echo "$STDIN_INPUT" | Check-File-Type) && exmsg "éæ³•çš„æ–‡ä»¶ç±»å‹"
  STDIN=true
else
  STDIN=false
fi

########################################################################

# ç®€å•æ£€æŸ¥ä¾èµ–å‘½ä»¤
NOT_FOUND=()
for i in sed jq curl cat grep file;do
  command -v $i &>/dev/null || NOT_FOUND+=($i)
done
((${#NOT_FOUND[@]})) && exmsg "ç¼ºå¤±å‘½ä»¤ ${NOT_FOUND[@]}"

########################################################################

# ç®€å•æ£€æŸ¥å¯é€‰å‘½ä»¤
EXTEND_NOT_FOUND=()
EXTEND_DIST=(fzf bat gum)
EXTEND_VAL=__has_extend_
for i in ${EXTEND_DIST[@]};do
  eval=$EXTEND_VAL$i
  if command -v $i &>/dev/null;then
    eval $eval=true
  else
    eval $eval=false
  fi
done

########################################################################

# è§£æå‚æ•°
argo=(
  a b c d e f g h i j k l m n o p q r s t u w x z
)
for i in "${argo[@]}";do
  eval "SHIFT_${i^}=0"
done

# ä¼˜å…ˆè§£æå¸®åŠ©å‚æ•°ï¼Œç›´æ¥é€€å‡º
for arg in "$@";do
  case "$arg" in
    --help|-h)
      HELP_VERSION=(
        'å‘½ä»¤'                    '  å·²å®‰è£…ç‰ˆæœ¬'  
        'bash'                    "$(Print-HighLight-Number <<< "${BASH_VERSION:-Null}")"
        'coreutils'               "$(Print-Command-Version ls)"
        'awk'                     "$(Print-Command-Version awk | cut -d, -f1)"
        'sed'                     "$(Print-Command-Version sed)"
        'grep'                    "$(Print-Command-Version grep)"
        'curl'                    "$(curl --version | head -1 | cut -d' ' -f1,2 | Print-HighLight-Number || echo Null)"
        'file'                    "$(file --version | head -1 | Print-HighLight-Number || echo Null)"
        'jq'                      "$(jq --version | head -1 | Print-HighLight-Number || echo Null)"
      )
      HELP_EXTEND_VERSION=(
        'å‘½ä»¤'                    '  å·²å®‰è£…ç‰ˆæœ¬'
        'bat'                     "$((Print-Command-Version bat | cut -d" " -f2-) 2>/dev/null || echo Null)"
        'gum'                     "$(Print-Command-Version gum 2>/dev/null || echo Null)"
        'fzf'                     "$(Print-Command-Version fzf 2>/dev/null || echo Null)"
      )
      HELP_OPTION=(
        '--help, -h'              'æ˜¾ç¤ºæ­¤å¸®åŠ©'
        '--session-help'          'æ˜¾ç¤ºä¼šè¯å¸®åŠ©'
        '--argtest, -a'           'æµ‹è¯•å‚æ•°ç»„åˆ'
        '--complete'              'æ‰“å°ä» BAI å¤åˆ¶çš„ bash å‘½ä»¤è¡¥å…¨è„šæœ¬'
        '--stream, -n'            'å¯ç”¨æµå¼å“åº” (å¦‚æœä¾›åº”å•†æ”¯æŒ)'
        '--thinking, -e'          'æ˜¾å¼å¯ç”¨æ·±åº¦æ€è€ƒé“¾ (å¦‚æœæ¨¡å‹æ”¯æŒ)'
        '--search, -g'            'æ˜¾å¼å¯ç”¨è”ç½‘æœç´¢ (å¦‚æœæ¨¡å‹æ”¯æŒ)'
        '--partial, -j'           'å¯ç”¨å‰ç¼€ç»­å†™ (å¦‚æœæ¨¡å‹æ”¯æŒ)'
        '--baseurl, -b'           'æŒ‡å®š OpenAI API BaseURL'
        '--apikey, -k'            'æŒ‡å®šæ¥å£å¯†é’¥'
        '--model, -m'             "æŒ‡å®šæ¨¡å‹ (<${c32}model${c0}> or <${c32}model${c33}1${c0}>,<${c32}model${c33}2${c0}>...)"
        '--username, -u'          'æŒ‡å®šç”¨æˆ·å'
        '--title, -t'             'æŒ‡å®šä¼šè¯æ ‡é¢˜ (å¤šè½®å¯¹è¯)'
        '--value, -v'             "å‘è„šæœ¬ç¯å¢ƒå†…èµ‹å€¼ï¼Œé€‰é¡¹å¯é‡å¤(${c33}DEBUG${c0})"
        '--no-limit-turns, -l'    'è§£é™¤å¯¹è¯è½®æ¬¡é™åˆ¶ (é™åˆ¶: 32)'
        '--no-limit-tools, -z'    "è§£é™¤å¯¹äºè¿‡å°è§„æ¨¡ (${c36}=<${c35}5b${c0}) æ¨¡å‹çš„å·¥å…·é™åˆ¶"
        '--inspect, -x'           "ä»…æ£€æŸ¥æ­¤è„šæœ¬è¯·æ±‚æ–¹å¼ (${c33}DEBUG${c0})"
        '--debug, -o'             "å¯ç”¨è°ƒè¯•è¾“å‡º (${c33}DEBUG${c0})"
        '--conemu-status, -p'     'å¯ç”¨ ConEmu è¿›åº¦æŒ‡ç¤ºç‰¹æ€§'
        '--wait-style, -w'        'æŒ‡å®šç­‰å¾…æ—¶çš„æŒ‡ç¤ºæ ·å¼'
        '--no-extend, -d'         "ç¦ç”¨æŒ‡å®šçš„å¯é€‰ä¾èµ–å‘½ä»¤ (<${c32}command${c33}1${c0}>,<${c32}command${c33}2${c0}>...)"
        '--no-tools, -q'          "è­¦ç”¨æŒ‡å®šçš„å‡½æ•°å·¥å…· (<${c32}funcname${c33}1${c0}>,<${c32}funcname${c33}2${c0}>...)"
        '--sysfile, -s'           "æŒ‡å®šä¸€ä¸ªå‘½ä»¤æç¤ºæ–‡ä»¶ (${c33}type: ${c32}text/markdown${c0})"
        '--histfile, -i'          "æŒ‡å®šä¸€ä¸ªå†å²è®°å½•æ–‡ä»¶ (${c33}type: ${c32}text-lines${c0})"
        '--config, -f'            "æŒ‡å®šä¸€ä¸ªç¯å¢ƒå˜é‡æ–‡ä»¶ (${c33}type: ${c32}posix-shell-env${c0})"
        '--callfile, -c'          "æŒ‡å®šä¸€ä¸ªå·¥å…·æ–‡ä»¶ (${c33}type: ${c32}json-lines${c0})"
      )
      HELP_ENV_MUST=(
        'OPENAI_API_KEY'          "æ¥å£å¯†é’¥ (ç­‰ä»·äº ${c32}-k${c0})"
        'OPENAI_API_MODEL'        "æ¨¡å‹åç§° (ç­‰ä»·äº ${c32}-m${c0})"
      )
      HELP_ENV_OPTAL=(
        'OPENAI_BASE_URL'         "èµ·å§‹åœ°å€ (é»˜è®¤ä¸º ${c34}openai${c0}ï¼Œç­‰ä»·äº ${c32}-b${c0})"
        'OPENAI_API_TEMP'         'é‡‡æ ·æ¸©åº¦'
        'OPENAI_STOP_TEXTS'       'ç»“æŸæ ‡è¯­'
        'OPENAI_TEXT_NUM'         'è¾“å‡ºæ–‡æœ¬æ•°é‡'
        'OPENAI_TOP_K'            'è´ªå©ªé‡‡æ ·é˜ˆå€¼'
        'OPENAI_TOP_P'            'ç²¾ç®€é‡‡æ ·é˜ˆå€¼'
        'OPENAI_PRESENCE'         'é‡å¤æƒ©ç½šé˜ˆå€¼'
        'OPENAI_FREQUENCY'        'é¢‘ç‡æƒ©ç½šé˜ˆå€¼'
        'OPENAI_MAX_TOKENS'       'é™åˆ¶æœ€å¤§è¾“å‡ºé‡'
        'OPENAI_ENABLE_STREAM'    "å¯ç”¨æµå¼å“åº” (ç­‰ä»·äº ${c32}-n${c0})"
        'OPENAI_ENABLE_SEARCH'    "å¯ç”¨è”ç½‘æœç´¢ (å¦‚æœæ¨¡å‹æ”¯æŒ, ç­‰ä»·äº ${c32}-g${c0})"
        'OPENAI_ENABLE_THINKING'  "å¯ç”¨æ·±åº¦æ€è€ƒé“¾ (å¦‚æœæ¨¡å‹æ”¯æŒ, ç­‰ä»·äº ${c32}-e${c0})"
        'OPENAI_ENABLE_PARTIAL'   "å¯ç”¨å‰ç¼€ç»­å†™ (å¦‚æœæ¨¡å‹æ”¯æŒ, ç­‰ä»·äº ${c32}-j${c0})"
      )
      HELP_ENV_OTHER=(
        'BAI_COLOR'               "GNU é£æ ¼é€‰é¡¹è¡Œä¸ºï¼Œæ˜¯å¦å¯ç”¨é¢œè‰²è¾“å‡º (${c32}never${c0},${c32}auto${c0},${c32}always${c0})"
        'BAI_TITLE'               "ä¼šè¯æ ‡é¢˜ (ç­‰ä»·äº ${c32}-t${c0})"
        'BAI_HISTFILE'            "å†å²è®°å½•æ–‡ä»¶ (ç­‰ä»·äº ${c32}-i${c0})"
        'BAI_USERNAME'            "ç”¨æˆ·å (ç­‰ä»·äº ${c32}-u${c0})"
        'BAI_WAIT_STYLE'          "ç­‰å¾…æ—¶çš„æŒ‡ç¤ºæ ·å¼ (ç­‰ä»·äº ${c32}-w${c0})"
        'BAI_LIMIT_TURNS'         "æ˜¯å¦é™åˆ¶å¯¹è¯è½®æ¬¡ (ç­‰ä»·äº ${c32}-l${c0})"
        'BAI_LIMIT_TOOLS'         "æ˜¯å¦é™åˆ¶è¿‡å°æ¨¡å‹çš„å·¥å…·è°ƒç”¨ (ç­‰ä»·äº ${c32}-z${c0})"
        'BAI_CALLING_FILE'        "Function Calling æ–‡ä»¶ (ç­‰ä»·äº ${c32}-c${c0})"
      )

      HELP_STYLE_OPTION=(
        'bar'                     'æ—‹è½¬ - ç»å…¸æ å‹'
        'arc'                     'æ—‹è½¬ - å¼§å½¢'
        'arrow'                   'æ—‹è½¬ - ç®­å¤´'
        'dotmatrix'               'æ—‹è½¬ - Npm é£æ ¼ç‚¹é˜µ'
        'bell'                    'æ—‹è½¬ - æ—¶é—´æµé€'
        'dot'                     'æ¥å› - æ”¶ç¼©çš„ç‚¹çŠ¶é“¾'
        'line'                    'æ¥å› - ç§»åŠ¨çš„ä¸‹åˆ’çº¿'
        'block'                   'æ¥å› - ç‚¹äº®æ–¹å—'
        'wave'                    'æ–¹å— - ä¸Šä¸‹èµ·ä¼'
        'square'                  'æ–¹å— - å˜æ¢æ‹¼è§’'
        'pushpull'                'æ–¹å— - å‰åæ”¶ç¼©'
        'roll'                    'å­—æ · - æ»šåŠ¨æ˜¾ç¤º'
        'invisible'               'å­—æ · - é€ä¸ªéšè—'
      )
      echo -e "${c32}$arg0${c0} (${c36}ä¿®æ”¹äº:${c0} ${c35}${status_version[0]}${c0}, ${c36}å¤§å°:${c0} ${c35}${status_version[1]}${c0}, ${c36}è¡Œæ•°:${c0} ${c35}${status_version[2]}${c0})
è°ƒç”¨ OpenAI API çš„ç»ˆç«¯èŠå¤©è„šæœ¬

${c36}ä¾èµ–é¡¹:${c0}
$(printf "  %-15b%b\n" "${HELP_VERSION[@]}")

${c36}å¯é€‰ä¾èµ–é¡¹:${c0}
$(printf "  %-15b%b\n" "${HELP_EXTEND_VERSION[@]}")

  ç”¨æ³•: ${c32}$arg0${c0} [ ${c33}æé—®${c0} | ${c33}æé—®æ–‡ä»¶${c0} | ${c33}é€‰é¡¹${c0} ]...
  
  å¯ä»¥åœ¨å‘½ä»¤è¡Œå‚æ•°ä¸­æé—®ï¼Œæˆ–è€…æŒ‡å®šä¸€ä¸ªåŒ…å«æé—®å†…å®¹çš„æ–‡ä»¶ã€‚
  ä¾‹å¦‚: ${c32}$arg0${c0} ${c33}./issue.txt${c0}   \e[2;37m# bai \"ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±\"${c0}
  
  æ­¤å¤–ï¼Œè¿˜å…è®¸ä½¿ç”¨ç®¡é“è¾“å…¥æ–‡ä»¶ï¼ˆå•æ¬¡å¯¹è¯ï¼‰å’Œä½¿ç”¨æŒ‡ä»¤æäº¤æ–‡ä»¶ï¼ˆå¤šè½®å¯¹è¯ï¼‰
  ä¾‹å¦‚:
    ${c32}cat${c0} ${c33}README.md${c0} ${c34}|${c0} ${c32}$arg0${c0} ${c33}\"è§£é‡Šä¸€ä¸‹è¿™ä¸ªè‡ªè¿°\"${c0}\n
  æˆ–è€…:
    ${c36}$user_prompt${c0} ${c32}.file${c0} ${c33}README.md${c0}
    ${c36}$user_prompt${c0} ${c33}è§£é‡Šä¸€ä¸‹è¿™ä¸ªè‡ªè¿°${c0}
  
  ${c35}é€‰é¡¹:${c0}
$(printf "    \e[1;34m%-27b${c0}%-4b\n" "${HELP_OPTION[@]}")

  åœ¨éœ€è¦æŒ‡å®šå‚æ•°çš„é€‰é¡¹æ”¯æŒä½¿ç”¨å¤šç§æ–¹å¼ï¼Œä»¥æµ‹è¯•é€‰é¡¹ ${c33}-a/--argtest${c0} ä¸ºä¾‹:
    ${c32}$arg0${c0} ${c33}-a${c0} ${c34}test${c0}
    ${c32}$arg0${c0} ${c33}-a${c0}${c34}test${c0}
    ${c32}$arg0${c0} ${c33}-a${c0}:${c34}test${c0}
    ${c32}$arg0${c0} ${c33}--argtest${c0}:${c34}test${c0}
    ${c32}$arg0${c0} ${c33}--argtest${c0} ${c34}test${c0}
    ${c32}$arg0${c0} ${c33}--argtest${c0}=${c34}test${c0}
  
  ä½¿ç”¨å‰éœ€è¦æ³¨å…¥ç¯å¢ƒå˜é‡
    å¿…é€‰å€¼:  
$(printf "      ${c33}%-25b${c0}%-4b\n" "${HELP_ENV_MUST[@]}")
    å¯é€‰å€¼:  
$(printf "      ${c33}%-25b${c0}%-4b\n" "${HELP_ENV_OPTAL[@]}")
    é¢å¤–é¡¹:
$(printf "      ${c33}%-25b${c0}%-4b\n" "${HELP_ENV_OTHER[@]}")

  æ ·å¼é€‰é¡¹ (${c32}-w${c0}/${c32}--wait-style${c0}):
$(printf "      ${c33}%-25b${c0}%-4b\n" "${HELP_STYLE_OPTION[@]}")
  
  æœªåœ¨å‘½ä»¤å‚æ•°ä¸­æé—®æ—¶å°†è¿›å…¥è¿ç»­å¯¹è¯æ¨¡å¼ï¼Œå¯ä¸Šä¸‹ç¿»é˜…è¾“å…¥è®°å½•
  è®°å½•å°†ä¿å­˜åˆ° ${c35}$HISTFILE${c0}
  åœ¨è¿ç»­å¯¹è¯æ¨¡å¼ä¸‹ä½¿ç”¨å±€å†…æŒ‡ä»¤ ${c32}.help${c0} æŸ¥çœ‹ç”¨æ³•
  
  å¯¹äº Function Calling åŠŸèƒ½æ”¯æŒï¼š
    å·¥å…·æ–‡ä»¶æ ¼å¼è¦æ±‚ä½¿ç”¨ JSON Linesï¼Œä»¥ä¾¿å¯¼å…¥å¤šä¸ªå·¥å…·ï¼Œä»¥ä¸‹æ˜¯åŸºæœ¬å•ä½æ•°æ®ç»“æ„ï¼š
    * éœ€è¦å‚æ•°çš„å‡½æ•°ï¼š
    \`\`\`json
$(jq -C <<< '{
              "name": "å‡½æ•°å, e.g example",
              "explicitly (å¯é€‰é¡¹)": "true æˆ– false, å­—ç¬¦ä¸²",
              "depend (å¯é€‰é¡¹)": "éœ€è¦å£°æ˜çš„ä¾èµ–å‘½ä»¤ä»¥åŠå¯é€‰ç›¸åº”çš„å‘½ä»¤åŒ…åï¼Œå¯æŒ‡å®šå¤šä¸ª, e.g rg:ripgrep,xargs:findutils", 
              "description": "å‡½æ•°åŸºæœ¬æè¿°",
              "function": "å¾…å°è£…çš„ Bash å‡½æ•°ä»£ç å—, e.g echo $1;echo $2",
              "parameters (å¯é€‰é¡¹)": {
                "type": "object",
                "properties": {
                  "å‚æ•°1, e.g arg1": {
                    "type": "string",
                    "description": "å‚æ•°åŸºæœ¬æè¿°"
                    }
                  }
                },
                "required": [
                  "è¦ä½¿ç”¨çš„å‚æ•°, e.g arg1"
                ]
              }
            }' 2>/dev/null |
  sed '12a\      '$'\e[2;37m"å‚æ•°2"...\e[0m' |
  sed '17a\    '$'\e[2;37m"å‚æ•°2"...\e[0m' | 
  cat -n)
    \`\`\`
    * æ— å‚æ•°å‡½æ•°å¯ä»…åŒ…å« \"name\"  \"description\"  \"function\" å­—æ®µ

  æ³¨æ„:
    ${c32}Function Calling${c0} æ”¯æŒä¸ºæœ€ç»ˆé˜¶æ®µæµ‹è¯•åŠŸèƒ½ï¼Œå·²éªŒè¯åœ¨å¤šä¸ªæ¨¡å‹ä¸‹åŸºæœ¬
    æ­£å¸¸å·¥ä½œï¼Œä½†æš‚ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚
    æµå¼å“åº”å·²è¿›å…¥æ­£å¼æµ‹è¯•é˜¶æ®µï¼Œå°†ä¸ä½¿ç”¨å†…ç½®é€å­—è¾“å‡ºåŠŸèƒ½ç¼“å­˜è¾“å‡ºã€‚
    ç›®å‰ ${c32}deepseek-reasoner${c0} æ€è€ƒé“¾å…¼å®¹ä»…åœ¨æµå¼å“åº”æ¨¡å¼åº”ç”¨ï¼Œä¸”æ€§èƒ½è¾ƒå·®
    æµå¼å“åº”å·²å°è¯•æ„å»ºé”™è¯¯å¤„ç†æœºåˆ¶ï¼Œä½†éƒ¨åˆ†ç‰¹æ€§ä¾æ—§å¯èƒ½åœ¨æ­¤ä¸¢å¤±ã€‚
    å› å†å²é—ç•™é—®é¢˜ï¼Œ${arg0} æš‚æ— æ³•æ”¯æŒ GNU é£æ ¼å‚æ•° ${c33}--color${c0}ï¼Œä½†å¯ç”¨ç¯å¢ƒ
    å˜é‡ ${c32}BAI_COLOR${c0} ä»£æ›¿ã€‚
    ç›®å‰æš‚æ— æ³•å®ç°å¯¹å¤§æ¨¡å‹å›åº”çš„æ‰“æ–­æ“ä½œï¼Œä»ç„¶å¤„äºè®¡åˆ’ä¸­ã€‚

  æç¤º:
    å¯ç”¨å‰ç¼€ç»­å†™åŠŸèƒ½åï¼Œè¿ç»­å¯¹è¯æ¨¡å¼ä¸‹ï¼Œåœ¨è¾“å…¥é—®é¢˜æœ«å°¾æ·»åŠ  ${c32}@prefix${c0} æ ‡è¯†
    å³å¯ä½¿ç”¨å‰ç¼€ç»­å†™åŠŸèƒ½:
      ${c34}$user_prompt${c0} ${c32}æ˜¥å¤©æ¥äº†ï¼Œä¸‡ç‰©å¤è‹${c0}${c33}@prefix${c0}

    è‡ª ${c33}$(Print-HighLight-Number <<<"Bash 5.3") ç‰ˆæœ¬å¼€å§‹ï¼Œ${c32}read${c0} å†…å»ºå¾—åˆ°å¢å¼ºï¼Œç°å·²åŠ å…¥å¯¹äºéƒ¨åˆ†å±€å†…æŒ‡ä»¤çš„è¡¥å…¨å‡½æ•°,
    ä»¥æœŸå¢å¼ºä½“éªŒã€‚
    åŠ å…¥å¯é€‰ä¾èµ–å‘½ä»¤ï¼Œåœ¨å®‰è£…è¿™äº›å‘½ä»¤åå°†ä¸€å®šç¨‹åº¦ä¸Šå¢å¼ºä½¿ç”¨ä½“éªŒï¼Œå¯é€šè¿‡ä¸Šè¿°å‘½ä»¤è¡Œå‚
    æ•°é€‰æ‹©æ€§ç¦ç”¨å‘½ä»¤æ‰©å±•ï¼š
      ${c32}bat${c0}:   å¯¹äº ${c32}.copy${c0} æŒ‡ä»¤å’Œé™æ€éæµè¾“å‡ºä½¿ç”¨é«˜äº®è¯­æ³•ï¼Œä»¥å¢å¼ºè§†è§‰æ•ˆæœ
      ${c32}gum${c0}:   å¯¹äº ç”¨æˆ·äº¤äº’åŠŸèƒ½å¢å¼º/æ›¿æ¢ï¼Œä½†å°†æŸå¤±éƒ¨åˆ†ç‰¹æ€§
      ${c32}fzf${c0}:   å¯¹äº ${c33}Bash${c0} å†å²è®°å½•åå‘åŒ¹é…åŠŸèƒ½ï¼ˆ${c35}Ctrl-R${c0}ï¼‰å¢å¼º

    é€€å‡ºçŠ¶æ€:
      é€šå¸¸æ˜¯ä¸ç¡®å®šçš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä»…åœ¨å‘ç”Ÿé”™è¯¯æ—¶è¿”å›éé›¶å€¼

  $(Set-Link-Text "$arg0" "https://gitee.com/hornleaf/bai") å‘½ä»¤è¡Œå·¥å…· é¡¹ç›®åœ°å€: <${c4}https://gitee.com/hornleaf/bai${c0}> 
  è¯·å‘ <${c4}hornleaf_cn@outlook.com${c0}> æˆ– <${c4}https://gitee.com/hornleaf/bai/issues${c0}> åé¦ˆ
  é—®é¢˜æˆ–æå‡ºæ”¹è¿›æ€§å»ºè®®
  
  ** å¼€ä¸ªç©ç¬‘ï¼Œä»“åº“é¡¹ç›®é‡Œæ ¹æœ¬æ²¡æœ‰è¿™ä¹ˆå¤šåŠŸèƒ½ï¼Œå…¨è®©æˆ‘è‡ªä¸ªç§åäº†\n"
      exit
  esac
done

# æ¬¡ä¼˜å…ˆè§£ææµ‹è¯•å‚æ•°ï¼Œç›´æ¥é€€å‡º
for arg in "$@";do
  case "$arg" in
    --argtest*|-a*)
      TEST_ARG="ARG_TEST_VALUE"
      ARG_ERR="æœªæŒ‡å®šå‚æ•°" \
      ARG_OPTS="a,argtest" \
      ARG_KEY="$TEST_ARG" \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        echo " + shift ${BASH_REMATCH[1]}"
      else
        exmsg "$ARGS_ERR"
      fi
      echo " + arg-value: ${!TEST_ARG}"
      exec echo " + exit"
      ;;
    --complete)
      sed -n \
        "$(
          sed -n '/^# __COMPLETE_HEAD__/=;/^# __COMPLETE_TAIL__/=' "$BASH_SOURCE" |
          tr '\n' , | sed 's/,$/p/'
      )" "$BASH_SOURCE" |
      sed '1d;$d;s/^# //g' |
      sed "s/%Name%/$arg0/g"
      exit
      ;;
    --session-help)
      Get-Session-Help
      exit
      ;;
  esac
done

# æœ€åè§£æå‚æ•° ä¼˜å…ˆçº§ä½
for arg in "$@";do
  ARGS_ERR="$arg0: å‚æ•°è§£æé”™è¯¯..."
  arg="$1"
  case "$1" in
    # ä½¿ç”¨æ£€æŸ¥æ¨¡å¼
    --inspect|-x)
      Limit-Repeation-Arguments SHIFT_X "$1"
      DEBUG_MODE=true
      shift
      ;;
    # å¯ç”¨è°ƒè¯•è¾“å‡º
    --debug|-o)
      Limit-Repeation-Arguments SHIFT_O "$1"
      DEBUG=true
      shift
      ;;
    # å¯ç”¨æµæ¨¡å¼
    --stream|-n)
      Limit-Repeation-Arguments SHIFT_N "$1"
      OPENAI_ENABLE_STREAM=true
      shift
      ;;
    # å¯ç”¨æ·±åº¦æ€è€ƒé“¾
    --thinking|-e)
      Limit-Repeation-Arguments SHIFT_E "$1"
      OPENAI_ENABLE_THINKING=true
      shift
      ;;
    # å¯ç”¨è”ç½‘æœç´¢
    --search|-g)
      Limit-Repeation-Arguments SHIFT_G "$1"
      OPENAI_ENABLE_SEARCH=true
      shift
      ;;
    # å¯ç”¨éƒ¨åˆ†å“åº”
    --partial|-j)
      Limit-Repeation-Arguments SHIFT_J "$1"
      OPENAI_ENABLE_PARTIAL=true
      shift
      ;;
    # è§£é™¤å¯¹è¯è½®æ¬¡é™åˆ¶
    --no-limit-turns|-l)
      Limit-Repeation-Arguments SHIFT_L "$1"
      BAI_LIMIT_TURNS=false
      shift
      ;;
    # è§£é™¤è¿‡å°æ¨¡å‹çš„å·¥å…·è°ƒç”¨é™åˆ¶
    --no-limit-tools|-z)
      Limit-Repeation-Arguments SHIFT_Z "$1"
      BAI_LIMIT_TOOLS=false
      shift
      ;;
    # å¯ç”¨ ConEmu è¿›åº¦æŒ‡ç¤ºç‰¹æ€§
    --conemu-status|-p)
      Limit-Repeation-Arguments SHIFT_P "$1"
      CONEMU_STATUS=true
      shift
      ;;
    # ä»å‚æ•°å‘è„šæœ¬å†…æ³¨å…¥å˜é‡
    --value*|-v*)
      # å¯é‡å¤å‚æ•°ï¼Œæ— éœ€ä½¿ç”¨å‚æ•°é‡å¤æ£€æŸ¥ç»„ä»¶
      VAR_ARG="BAI_INJECT_VAR"
      ARG_ERR="æœªæŒ‡å®šå˜é‡" \
      ARG_OPTS="v,value" \
      ARG_KEY="$VAR_ARG" \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        shift ${BASH_REMATCH[1]}
      else
        exmsg "$ARGS_ERR"
      fi
      __bai_inject_var="${!VAR_ARG}"
      # æ£€æŸ¥æ˜¯å¦ç¬¦åˆåŸºæœ¬èµ‹å€¼å½¢å¼
      if [[ "$__bai_inject_var" == *=* ]];then
        # æ£€æŸ¥æ˜¯å¦ç¬¦åˆåŸºæœ¬èµ‹å€¼è§„èŒƒ
        if [[ "${__bai_inject_var%%=*}" =~ ^[a-zA-Z_][a-zA-Z0-9_]*$ ]];then
          # ç¬¦åˆè§„èŒƒï¼Œæ³¨å…¥å˜é‡
          # æ£€æŸ¥æ˜¯å¦å·²è¢«æ³¨å…¥è¿‡
          if eval "\${BAI_INJECT_KEY_${__bai_inject_var%%=*}:-false}";then
            emsg "å˜é‡ ${__bai_inject_var%%=*} å·²è¢«æ³¨å…¥è¿‡"
          else
            printf -v "BAI_INJECT_KEY_${__bai_inject_var%%=*}" true
            printf -v "${__bai_inject_var%%=*}" "${__bai_inject_var#*=}" || exmsg "å˜é‡æ³¨å…¥å¤±è´¥"
          fi
        else
          exmsg "å˜é‡åä¸ç¬¦åˆè§„èŒƒ"
        fi
      else
        exmsg "å˜é‡èµ‹å€¼ä¸ç¬¦åˆè§„èŒƒ"
      fi
      ;;
    # æŒ‡å®šæœåŠ¡å•†åŸºæœ¬æ¥å£åœ°å€
    --baseurl*|-b*)
      Limit-Repeation-Arguments SHIFT_B "$1"
      ARG_ERR="æœªæŒ‡å®š OpenAI API BaseURL" \
      ARG_OPTS="b,baseurl" \
      ARG_KEY="OPENAI_BASE_URL" \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        shift ${BASH_REMATCH[1]}
      else
        exmsg "$ARGS_ERR"
      fi
      ;;
    # æŒ‡å®šæ¥å£å¯†é’¥
    --apikey*|-k*)
      Limit-Repeation-Arguments SHIFT_K "$1"
      ARG_ERR="æœªæŒ‡å®šæ¥å£å¯†é’¥" \
      ARG_OPTS="k,apikey" \
      ARG_KEY="OPENAI_API_KEY" \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        shift ${BASH_REMATCH[1]}
      else
        exmsg "$ARGS_ERR"
      fi
      ;;
    # æŒ‡å®šæ‰€ç”¨æ¨¡å‹
    --model*|-m*)
      Limit-Repeation-Arguments SHIFT_M "$1"
      ARG_ERR="æœªæŒ‡å®šæ¨¡å‹" \
      ARG_OPTS="m,model" \
      ARG_KEY="OPENAI_API_MODEL" \
      ARG_USE_ARRAY=true \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        shift ${BASH_REMATCH[1]}
      else
        exmsg "$ARGS_ERR"
      fi
      ;;
    # æŒ‡å®šå†å²è®°å½•æ–‡ä»¶
    --histfile*|-i*)
      Limit-Repeation-Arguments SHIFT_I "$1"
      ARG_ERR="æœªæŒ‡å®šæ–‡ä»¶" \
      ARG_OPTS="i,histfile" \
      ARG_KEY="HISTFILE" \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        shift ${BASH_REMATCH[1]}
      else
        exmsg "$ARGS_ERR"
      fi
      ;;
    # æŒ‡å®šæ–°æ ‡é¢˜
    --title*|-t*)
      Limit-Repeation-Arguments SHIFT_T "$1"
      ARG_ERR="æœªæŒ‡å®šæ ‡é¢˜" \
      ARG_OPTS="t,title" \
      ARG_KEY="BAI_TITLE" \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        shift ${BASH_REMATCH[1]}
      else
        exmsg "$ARGS_ERR"
      fi
      ;;
    # æŒ‡å®šç”¨æˆ·å
    --username*|-u*)
      Limit-Repeation-Arguments SHIFT_U "$1"
      ARG_ERR="æœªæŒ‡å®šç”¨æˆ·å" \
      ARG_OPTS="u,username" \
      ARG_KEY="BAI_USERNAME" \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        shift ${BASH_REMATCH[1]}
      else
        exmsg "$ARGS_ERR"
      fi
      ;;
    # æŒ‡å®šç¯å¢ƒå˜é‡æ–‡ä»¶
    --config*|-f*)
      Limit-Repeation-Arguments SHIFT_F "$1"
      FILE_ARG="BAI_ENV_FILE"
      ARG_ERR="æœªæŒ‡å®šæ–‡ä»¶" \
      ARG_OPTS="f,config" \
      ARG_KEY="$FILE_ARG" \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        shift ${BASH_REMATCH[1]}
      else
        exmsg "$ARGS_ERR"
      fi
      if [ -f "${!FILE_ARG}" ];then
        Limit-FileSize "${!FILE_ARG}" 80,512
        if (
             ! grep -Ev '^\s*(export\s+)?[a-zA-Z_][a-zA-Z0-9_]*=.*(#.*)?$' "${!FILE_ARG}" |
             grep -qEv '^\s*$|^\s*#' &&
             ! grep -qE '\$\(|`' "${!FILE_ARG}"
            );then
          source "${!FILE_ARG}"
        else
          exmsg "$arg1: ${!FILE_ARG}: æ•æ„Ÿçš„æ–‡ä»¶å†…å®¹"
        fi
      else
        exmsg "$arg1: ${!FILE_ARG}: æ–‡ä»¶ä¸å­˜åœ¨"
      fi
      ;;
    # æŒ‡å®šåŸºæœ¬æç¤ºè¯æ–‡ä»¶
    --sysfile*|-s*)
      Limit-Repeation-Arguments SHIFT_S "$1"
      FILE_ARG="BAI_SYSTEM_FILE"
      ARG_ERR="æœªæŒ‡å®šæ–‡ä»¶" \
      ARG_OPTS="s,sysfile" \
      ARG_KEY="$FILE_ARG" \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        shift ${BASH_REMATCH[1]}
      else
        exmsg "${!ARGS_ERR}"
      fi
      if [ -f "${!FILE_ARG}" ];then
        # é™åˆ¶æ–‡ä»¶å¤§å°ï¼Œæœ€å°5å­—èŠ‚ï¼Œæœ€å¤§10åƒå­—èŠ‚
        Limit-FileSize "${!FILE_ARG}" 5,10240
        OPENAI_SYSTEM_PROMPT="$(cat "${!FILE_ARG}")"
      elif [ -d "${!FILE_ARG}" ];then
        exmsg "$arg1: ${!FILE_ARG}: æ˜¯ä¸€ä¸ªç›®å½•"
      else
        exmsg "$arg1: æ‰¾ä¸åˆ°æ–‡ä»¶: ${!FILE_ARG}"
      fi
      ;;
    # æŒ‡å®š Function Calling å·¥å…·æ–‡ä»¶
    --callfile*|-c*)
      Limit-Repeation-Arguments SHIFT_C "$1"
      FILE_ARG="BAI_CALLING_FILE"
      ARG_ERR="æœªæŒ‡å®šæ–‡ä»¶" \
      ARG_OPTS="c,callfile" \
      ARG_KEY="$FILE_ARG" \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        shift ${BASH_REMATCH[1]}
      else
        exmsg "${!ARGS_ERR}"
      fi
      if [ -f "${!FILE_ARG}" ];then
        Limit-FileSize "${!FILE_ARG}" 100,10240
        Check-Tools "${!FILE_ARG}"
        TOOLS=true
      elif [ -d "${!FILE_ARG}" ];then
        exmsg "$arg1: ${!FILE_ARG}: æ˜¯ä¸€ä¸ªç›®å½•"
      else
        exmsg "$arg1: æ‰¾ä¸åˆ°æ–‡ä»¶: ${!FILE_ARG}"
      fi
      ;;
    --no-extend*|-d*)
      Limit-Repeation-Arguments SHIFT_D "$1"
      VAR_ARG="BAI_DISABLE_EXTEND"
      ARG_ERR="æœªæŒ‡å®šæ’é™¤é¡¹" \
      ARG_OPTS="d,no-extend" \
      ARG_KEY="$VAR_ARG" \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        shift ${BASH_REMATCH[1]}
      else
        exmsg "${!ARGS_ERR}"
      fi
      if [[ "${!VAR_ARG}" =~ ^[a-zA-Z0-9_]+($|,([a-zA-Z0-9_]+,)*[a-zA-Z0-9_]+)?$ ]];then
        __bai_disable_coommand=(${!VAR_ARG//,/ })
        for i in ${__bai_disable_coommand[@]};do
          if [[ " ${EXTEND_DIST[@]} " == *" $i "* ]];then
              command -v "$i" &>/dev/null || exmsg "$i: æ‰¾ä¸åˆ°å‘½ä»¤"
              eval $EXTEND_VAL$i=false
            else
              exmsg "$i: éå¯é€‰ä¾èµ–çš„å‘½ä»¤"
          fi
        done
      else
        exmsg "éæ³•çš„å‘½ä»¤æ’é™¤åå•"
      fi
      ;;
    --no-tools*|-q*)
      Limit-Repeation-Arguments SHIFT_Q "$1"
      VAR_ARG="BAI_DISABLE_TOOLS"
      ARG_ERR="æœªæŒ‡å®šæ’é™¤é¡¹" \
      ARG_OPTS="q,no-tools" \
      ARG_KEY="$VAR_ARG" \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        shift ${BASH_REMATCH[1]}
      else
        exmsg "${!ARGS_ERR}"
      fi
      [[ "${!VAR_ARG}" =~ ^[a-zA-Z0-9_]+($|,([a-zA-Z0-9_]+,)*[a-zA-Z0-9_]+)?$ ]] ||
      exmsg "éæ³•çš„å‡½æ•°ç¦ç”¨åå•"
      ;;
    --wait-style*|-w*)
      Limit-Repeation-Arguments SHIFT_W "$1"
      VAR_ARG="BAI_WAIT_STYLE"
      ARG_ERR="æœªæŒ‡å®šç­‰å¾…æ ·å¼" \
      ARG_OPTS="w,wait-style" \
      ARG_KEY="BAI_WAIT_STYLE" \
      Get-Arguments-Value "$@"
      RETURN=$?
      if [[ "$RETURN" =~ ^10([12])$ ]];then
        shift ${BASH_REMATCH[1]}
      else
        exmsg "$ARGS_ERR"
      fi
      _all_wait_style=(
        bar
        arc
        dot
        line
        bell
        wave
        roll
        dice
        block
        arrow
        square
        phase
        pushpull
        invisible
        dotmatrix
        rectangle
      )
      if [[ " ${_all_wait_style[@]} " == *" ${!VAR_ARG} "* ]];then
        Switch-Wait-Frame "${!VAR_ARG}"
      else
        _for_wait_style=()
        for i in "${_all_wait_style[@]}";do
          [[ "$i" == *"${!VAR_ARG}"* ]] && _for_wait_style+=("$i")
        done
        ((${#_for_wait_style[@]})) && {
          emsg "æœªçŸ¥çš„ç­‰å¾…æ ·å¼: ${c32}${!VAR_ARG}${c0}, æ‰¾åˆ°åŒ…å« \"${c32}${!VAR_ARG}${c0}\" çš„æ ·å¼:"
          printf " --- ${c32}%s${c0}\n" "${_for_wait_style[@]}"
          exec echo
        }
        # åˆå§‹åŒ–æœ€å°è·ç¦»å’Œæœ€ç›¸ä¼¼å‚æ•°
        _min_da=5
        _min_distance="$_min_da"
        _sim_option=""
        # éå†æ‰€æœ‰æœ‰æ•ˆå‚æ•°ï¼Œè®¡ç®—è·ç¦»
        for o in "${_all_wait_style[@]}";do
          _distance=$(Get-Levenshtein "${!VAR_ARG}" "$o")
          if ((_distance<_min_distance));then
            _min_distance="$_distance"
            _sim_option="$o"
          fi
        done
        if ((_min_distance<_min_da));then
          exmsg "æœªçŸ¥çš„ç­‰å¾…æ ·å¼: ${c33}${!VAR_ARG}${c0}, æ‰¾åˆ°è·ç¦»æœ€è¿‘çš„æ ·å¼ ${c32}$_sim_option${c0}"
        else
          exmsg "æœªçŸ¥çš„ç­‰å¾…æ ·å¼ ${c33}${!VAR_ARG}${c0}"
        fi
      fi
      ;;
    --)
      shift
      ;;
    -*)
      # æ£€æŸ¥å‚æ•°
      if [[ "$1" == --* ]];then
        _all_options=(
          help
          session-help
          argtest
          stream
          thinking
          search
          partial
          debug
          no-limit-turns
          no-limit-tools
          baseurl
          apikey
          model
          title
          inspect
          sysfile
          histfile
          config
          callfile
          no-extend
          wait-style
          conemu-status
        )
        _arg1=${1:2}
        _for_num=0
        _for_options=()
        for i in "${_all_options[@]}";do
          [[ "$i" == *"$_arg1"* ]] && _for_options+=("$i")
        done
        ((${#_for_options[@]})) && {
          emsg "æœªçŸ¥çš„é€‰é¡¹: ${c33}$1${c0}, æ‰¾åˆ°åŒ…å« \"${c32}$_arg1${c0}\" çš„é€‰é¡¹:"
          printf "  ${c32}--%s${c0}\n" "${_for_options[@]}"
          exec echo
        }
        # åˆå§‹åŒ–æœ€å°æ±‰æ˜è·ç¦»å’Œæœ€ç›¸ä¼¼å‚æ•°
        _min_da=5
        _min_distance="$_min_da"
        _sim_option=""
        # éå†æ‰€æœ‰æœ‰æ•ˆå‚æ•°ï¼Œè®¡ç®—æ±‰æ˜è·ç¦»
        for o in "${_all_options[@]}";do
          _distance=$(Get-Levenshtein "$_arg1" "$o")
          if ((_distance<_min_distance));then
            _min_distance="$_distance"
            _sim_option="$o"
          fi
        done
        if ((_min_distance<_min_da));then
          exmsg "æœªçŸ¥çš„é€‰é¡¹: ${c33}$1${c0}, æ‰¾åˆ°è·ç¦»æœ€è¿‘çš„é€‰é¡¹ ${c32}--$_sim_option${c0}"
        else
          exmsg "æœªçŸ¥çš„é€‰é¡¹ ${c33}$1${c0}"
        fi
      else
        exmsg "æœªçŸ¥çš„é€‰é¡¹ ${c33}$1${c0}"
      fi
      ;;
    *)
      # è¾“å…¥æé—®æ–‡ä»¶æˆ–æé—®
      if [ "$1" ];then
        if [[ -z "$OPENAI_USER_PROMPT" ]];then
          OPENAI_USER_PROMPT="${1}"
          [[ -f "$OPENAI_USER_PROMPT" ]] && OPENAI_USER_PROMPT="$(cat "$OPENAI_USER_PROMPT")"
          shift
        else
          exmsg "è¿‡å¤šçš„æé—®"
        fi
      fi
      ;;
  esac
done

########################################################################

# è¿›è¡Œç¬¬ä¸€ä¸ªè°ƒè¯•è¾“å‡º
Get-Timer
debug "è„šæœ¬åˆå§‹åŒ–å®Œæˆ, è€—æ—¶: $Get_Timer"
debug "å¼€å§‹åŠ è½½ä¸»åŠŸèƒ½..."
Get-Timer

########################################################################

# ç»ˆç«¯æ ‡é¢˜
function get.session.title(){
  [ "$BAI_TITLE" ] || __custom_title_status=false
  if $__custom_title_status;then
    BAI_TITLE="${1:-$BAI_TITLE}"
  else
    BAI_TITLE="${arg0^} Session$([ "$BAI_USERNAME" ] && echo -n " - $BAI_USERNAME")"
  fi
  debug "é¢„è®¾ç½®ç»ˆç«¯æ ‡é¢˜: $BAI_TITLE"
}
get.session.title

########################################################################

# è®¾ç½® OpenAI API åŸå§‹åœ°å€ã€å¯†é’¥ã€æ¨¡å‹ç­‰
[[ -z "${OPENAI_API_KEY}" || -z "${OPENAI_API_MODEL}" ]] &&
exmsg "ç¼ºå°‘ç¯å¢ƒå˜é‡\nè‡³å°‘éœ€æä¾› ${c32}æ¥å£å¯†é’¥${c0} å’Œ ${c32}æ¥å£æ¨¡å‹${c0}\nç”¨æ³•è¯¦è§ ${c32}$arg0${c0} ${c33}--help${c0}\n"
: ${OPENAI_BASE_URL:="https://api.openai.com"}
API_AUTH="Authorization: Bearer $OPENAI_API_KEY"
debug "å·²è®¾ç½® OpenAI API åŸå§‹åœ°å€: $OPENAI_BASE_URL"
debug "å·²è®¾ç½® OpenAI API å¯†é’¥(éšè—): ${OPENAI_API_KEY//?/\*}"
debug "å·²è®¾ç½® OpenAI API æ¨¡å‹: $OPENAI_API_MODEL"

# å¤„ç†æ ‡å‡†è¾“å…¥
if [[ ! -z "$STDIN_INPUT" ]];then
  # STDIN_INPUT="$(printf '%s' "$STDIN_INPUT" | jq -Rsa . | sed -e 's/^"//' -e 's/"$//')" # è½¬ä¹‰æ ‡å‡†è¾“å…¥ä»¥ç¡®ä¿å®‰å…¨
  STDIN_INPUT="è¿™æ˜¯æ¥è‡ªæ ‡å‡†è¾“å…¥çš„å†…å®¹:"$'\n---\n'"$STDIN_INPUT"$'\n---\n\n'
  debug "æ¥å—æ¥è‡ªæ ‡å‡†è¾“å…¥çš„å†…å®¹..."
fi

########################################################################

debug "å¼€å§‹ç­›æŸ¥å˜é‡ç±»å‹..."

## ç­›æŸ¥éæ³•å€¼
typeof_index=0

# å˜é‡å,å˜é‡ç±»å‹
type_of=(
  # BAI å†…å»º
  "BAI_TITLE",string                # æ ‡é¢˜
  "BAI_USERNAME",string             # ç”¨æˆ·å
  "BAI_LIMIT_TURNS",boolean         # é™åˆ¶å¯¹è¯è½®æ¬¡
  "BAI_WAIT_STYLE",string           # ç­‰å¾…æ ·å¼
  "BAI_LIMIT_TOOLS",boolean         # é™åˆ¶å·¥å…·è°ƒç”¨
  "BAI_CALLING_FILE",string         # è°ƒç”¨å·¥å…·æ–‡ä»¶
  # OpenAI æ¥å£
  "OPENAI_API_KEY",string           # æ¥å£å¯†é’¥
  "OPENAI_API_MODEL",string         # æ¥å£æ¨¡å‹
  "OPENAI_API_TEMP",number          # æ¥å£æ¸©åº¦
  "OPENAI_TOP_K",number             # æ¥å£TopK
  "OPENAI_TOP_P",number             # æ¥å£TopP
  "OPENAI_PRESENCE",number          # æ¥å£å­˜åœ¨æƒ©ç½š
  "OPENAI_FREQUENCY",number         # æ¥å£é¢‘ç‡æƒ©ç½š
  "OPENAI_TEXT_NUM",number          # æ¥å£æ–‡æœ¬æ•°é‡
  "OPENAI_MAX_TOKENS",number        # æ¥å£æœ€å¤§ä»¤ç‰Œ
  "OPENAI_BASE_URL",url             # æ¥å£åŸå§‹åœ°å€
  "OPENAI_ENABLE_STREAM",boolean    # æ¥å£æ˜¯å¦å¼€å¯æµå¼
  "OPENAI_ENABLE_THINKING",boolean  # æ¥å£æ˜¯å¦å¼€å¯æ€è€ƒ
  "OPENAI_ENABLE_SEARCH",boolean    # æ¥å£æ˜¯å¦å¼€å¯æœç´¢
  "OPENAI_ENABLE_PARTIAL",boolean   # æ¥å£æ˜¯å¦å¼€å¯éƒ¨åˆ†è¾“å‡º
)

# åˆ›å»ºéæ³•å€¼åˆ—è¡¨
type_invalid=()
type_invalid_value=()

# æ£€æŸ¥å˜é‡ç±»å‹
for i in ${type_of[@]};do
  type_value="${i%,*}"
  type_in="${i#*,}"
  type_r="$(Check-Variable-Type "$type_value")"
  [[ "$type_r" == "$type_in" || -z "${!type_value}" ]] || {
    debug "å˜é‡ ${c32}$type_value${c0} ç±»å‹æ£€æŸ¥æœªé€šè¿‡ï¼ŒåŠ å…¥éæ³•å€¼åˆ—è¡¨"
    type_invalid+=($type_value $type_in $type_r)
    type_invalid_value+=("${type_value}" "${!type_value}")
  }
done

# æŠ¥å‘Šå¼‚å¸¸çš„å˜é‡
if ! ((${#type_invalid[@]}==0));then
  emsg "ç¯å¢ƒå˜é‡ç±»å‹å¼‚å¸¸"
  echo -e "${c34}å¼‚å¸¸å˜é‡:${c0}"
  printf " - ${c32}%s${c0}=${c31}%s${c0}\n" "${type_invalid_value[@]}"
  echo -e "${c34}è¯´æ˜:${c0}"
  printf " - å˜é‡ ${c32}%s${c0} åº”è¯¥ä½¿ç”¨ ${c34}%s${c0} ç±»å‹ï¼Œä½†æ˜¯é”™è¯¯çš„ä½¿ç”¨äº† ${c31}%s${c0} ç±»å‹\n" "${type_invalid[@]}"
  echo
  let typeof_index++
fi

debug "ç­›æŸ¥å˜é‡ç±»å‹å®Œæˆ, ç»§ç»­ç­›æŸ¥ç»„åˆç±»å‹å˜é‡..."

# ç»„åˆç±»å‹å˜é‡åˆ—è¡¨
vararray_typeof=(
  "OPENAI_API_MODEL"::string       # æ¥å£æ¨¡å‹
)

# æ£€æŸ¥ç»„åˆç±»å‹å˜é‡
for i in ${vararray_typeof[@]};do
  var="${i%::*}"
  type="${i#*::}"
  Check-VarArray-Type "${!var}" "$type" "${var}"
done

# æŠ¥å‘Šå¼‚å¸¸çš„ç»„åˆç±»å‹å˜é‡
if ! ((${#__check_vararray[@]}==0));then
  emsg "ç¯å¢ƒå˜é‡ç»„åˆç±»å‹å¼‚å¸¸"
  echo -e "${c34}å¼‚å¸¸å˜é‡:${c0}"
  printf " - ${c32}%s${c0}\n" "${__check_vararray[@]}"
  echo -e "${c34}è¯´æ˜:${c0}"
  printf " - å˜é‡ ${c32}%s${c0} å…¶ä¸­éƒ¨åˆ†å€¼ ${c33}%s${c0} å¹¶é ${c34}%s${c0} ç±»å‹ï¼Œè€Œæ˜¯é”™è¯¯çš„ä½¿ç”¨äº† ${c31}%s${c0} ç±»å‹\n" "${__check_vararray[@]}" "${__check_vararray_type[@]}"
  echo
  let typeof_index++
fi

((typeof_index==0)) || {
  debug "ç¯å¢ƒå˜é‡ç±»å‹æ£€æŸ¥æœªé€šè¿‡ï¼Œé€€å‡ºè„šæœ¬"
  exit 1
}

debug "å˜é‡ç±»å‹æ£€æŸ¥å®Œæˆ, å°†ç»„åˆç±»å‹å˜é‡è½¬æ¢ä¸ºæ•°ç»„..."

# å°†ç»„åˆç±»å‹å˜é‡è½¬æ¢ä¸ºæ•°ç»„, å¹¶è¦†å†™ç¬¬ä¸€ä¸ªç´¢å¼•ä½œä¸ºé»˜è®¤å€¼ key => key_in_array, key_in_array[0] => key
for i in ${vararray_typeof[@]};do
  i="${i%::*}"
  if [[ "${!i}" =~ ^([^,]+)(,[^,]+)*$ ]];then
    eval "${i}_in_array=(${!i//,/ })"
    eval "$i=\"\$${i}_in_array\""
  fi
done

########################################################################

debug "æ„å»º OpenAI åŸºæœ¬è¯·æ±‚ä½“..."

# åˆ¶ä½œèµ·å§‹è¯·æ±‚å†…å®¹
builtin printf -v data \
  '{
    "model": "%s",
    "stream": %s,
    "enable_thinking": %s,
    "enable_search": %s,
    "messages": []
  }' \
  "$OPENAI_API_MODEL" "$OPENAI_ENABLE_STREAM" "$OPENAI_ENABLE_THINKING" "$OPENAI_ENABLE_SEARCH"

debug "åŸºæœ¬è¯·æ±‚ä½“æ„å»ºå®Œæˆ, ç»§ç»­æ‰©å±•è¯·æ±‚ä½“..."

# åŠ¨æ€åŠ å…¥é”®å€¼ï¼ˆjson æ ¼å¼ï¼‰
function data.append(){
  local key="$1" value="$2" type="$3"
  [[ "$type" == "--no-json" ]] && type="" || type="json"
  [[ -n "$value" ]] && data=$(jq --arg"$type" "$key" "$value" ". += {\"$key\": \$$key}" <<< "$data")
}

# çµæ´»ä¿®æ”¹é”®å€¼
function data.setkey(){
  local key="$1" value="$2"
  [[ -n "$value" ]] && data=$(jq --arg "$key" "$value" ".\"$key\" = \$$key" <<< "$data")
}

# åŠ¨æ€åŠ å…¥ç³»ç»Ÿæç¤º
function system_msg.append(){
  local content="$1"
  data="$(jq --arg content "$content" '.messages += [{"role": "system", "content": $content}]' <<< "$data")"
}

data.append "max_tokens" "$OPENAI_MAX_TOKENS"          # æœ€å¤§ tokens è¾“å‡ºé‡
data.append "n" "$OPENAI_TEXT_NUM"                     # æ–‡æœ¬èŒƒå›´
data.append "temperature" "$OPENAI_API_TEMP"           # æ¨¡å‹æ¸©åº¦
data.append "top_k" "$OPENAI_TOP_K"                    # è´ªå©ªé‡‡æ ·
data.append "top_p" "$OPENAI_TOP_P"                    # ç²¾ç®€é‡‡æ ·
data.append "presence_penalty" "$OPENAI_PRESENC"       # é‡å¤æƒ©ç½š
data.append "frequency_penalty" "$OPENAI_FREQUENCY"    # é¢‘ç‡æƒ©ç½š

# ç»“æŸæ ‡è¯­
if [ "$OPENAI_STOP_TEXTS" ];then
  array2json="$(jq -n --args '$ARGS.positional' --args "${OPENAI_STOP_TEXTS[@]}")"
  data.append "stop" "$array2json"                     # ç»“æŸæ ‡è¯­
fi

debug "æ­£åœ¨æ‰©å±•ä¸ªæ€§åŒ–å†…å®¹..."

# ç”¨æˆ·å
[ "$BAI_USERNAME" ] && {
  system_msg.append "ä½ éœ€è¦ä»¥æ­¤ç§°å‘¼ç”¨æˆ·: \"$BAI_USERNAME\", å¼ºè°ƒ: è¿™æ˜¯ç”¨æˆ·å, ä¸æ˜¯ä½ æ‰€ä½¿ç”¨çš„æ˜µç§°"
  debug "ä½¿ç”¨çš„ç”¨æˆ·å: $BAI_USERNAME"
}

# æç¤ºå‘½ä»¤
[ "$OPENAI_SYSTEM_PROMPT" ] &&
system_msg.append "$OPENAI_SYSTEM_PROMPT"

# è¡¥å……ï¼šå¯¹äºè¿‡å°è§„æ¨¡çš„æ¨¡å‹ç¦ç”¨ function calling åŠŸèƒ½ï¼Œå¹¶å‘èµ·è­¦å‘Š
if $BAI_LIMIT_TOOLS;then
  debug "æ£€æµ‹åˆ°é™åˆ¶å·¥å…·è°ƒç”¨åŠŸèƒ½ï¼Œæ­£åœ¨æ£€æŸ¥æ¨¡å‹è§„æ¨¡..."
  [[ "$OPENAI_API_MODEL" =~ ^.+[:-](([0-4]\.[1-9]|[1-4])[bB])$ ]] && {
    debug "æ˜¾å¼æŒ‡å‘çš„æ¨¡å‹è§„æ¨¡è¿‡å°ï¼Œå°†å˜é‡ TOOLS è®¾ç½®ä¸º falseï¼Œå‘å‡ºè­¦å‘Š"
    TOOLS=false
    msg "æ˜¾å¼æŒ‡å‘çš„æ¨¡å‹è§„æ¨¡è¿‡å° (${c33}${BASH_REMATCH[1]}${c0})ï¼Œå·²ç¦ç”¨ ${c32}Function Calling${c0} åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨æ›´å¤§å‚æ•° (${c36}=<${c0}${c35}5b${c0}) çš„æ¨¡å‹æˆ–æ‰‹åŠ¨è°ƒç”¨æŒ‡ä»¤";}
fi

# å¯ç”¨ Function Calling åŠŸèƒ½
if $TOOLS;then
  __bai_disable_function=(${BAI_DISABLE_TOOLS//,/ })
  debug "Function Calling åŠŸèƒ½å·²å¯ç”¨ï¼Œæ­£åœ¨åŠ è½½å·¥å…·é¢„å¤„ç†..."
  data.append "choice" "auto" --no-json
  toolsdata="$(jq -s . "$BAI_CALLING_FILE")"
  tools="$(jq '. |= map({"type": "function","function": .})' <<<"$toolsdata")" 
  data="$(jq --argjson tools "$(jq 'map(del(.function.function))' <<<"$tools")" '.tools = $tools' <<< "$data")"
  function_head="bai::function-calling"
  __bai_function_tools=()
  while IFS= read -r line;do
    function_fromjson_name="$(cut -d' ' -f1 <<< "$line")"
    __bai_function_tools+=("$function_fromjson_name")
    [[ " ${__bai_disable_function[*]} " == *" ${function_fromjson_name} "* ]] && {
      debug "å‘ç°å‘½ä»¤è¡Œå‚æ•°è¦æ±‚ç¦ç”¨çš„å‡½æ•°: $function_fromjson_name"
      continue
    }
    function_name="$function_head::$function_fromjson_name"
    declare -A gco_explicitly["$function_name"]="$(cut -d' ' -f2 <<<"$line")"
    for i in $(cut -d' ' -f3 <<< "$line" | tr ',' ' ');do
      [[ "$i" == "NULL" ]] && break
      bai_function_depend_command=${i%%:*}
      bai_function_depend_packname=${i##*:}
      [[ "$bai_function_depend_command" == "$bai_function_depend_packname" ]] || bai_function_depend_packname+=" ($bai_function_depend_command)"
      command -v $bai_function_depend_command &>/dev/null || declare -A __bai_function_depend_notfound["$function_fromjson_name"]="$bai_function_depend_packname"
    done
    function_code="$(cut -d' ' -f4- <<<"$line")"
    eval "$function_name(){ $function_code;}"
  done < <(jq -r '.[] | .name + " " + (.explicitly // "false") + " " + (.depend // "NULL") + " " + .function' <<< "$toolsdata")
  ((${#__bai_disable_function[@]}==0)) || {
    debug "ç­›æŸ¥å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šä½†å·¥å…·æ–‡ä»¶ä¸­å¹¶ä¸å­˜åœ¨çš„å‡½æ•°"
    __bai_disable_function_notfound=()
    for for_arg_tools in "${__bai_disable_function[@]}";do
      for for_file_tools in "${__bai_function_tools[@]}";do
        if [[ "$for_file_tools" == "$for_arg_tools" ]];then
          for_func_notfound=true
          break
        else
          for_func_notfound=false
        fi
      done
      $for_func_notfound ||
      __bai_disable_function_notfound+=("$for_arg_tools")
    done
    if ! ((${#__bai_disable_function_notfound[@]}==0));then
      debug "å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šçš„æ’é™¤é¡¹ä¸­æœ‰ä¸å­˜åœ¨çš„å‡½æ•°ï¼Œ${arg0^^} åº”å½“æ‹’ç»å¯åŠ¨"
      emsg "ä¸å­˜åœ¨çš„å‡½æ•°å·¥å…·:"
      printf " ${c34}-${c0} ${c33}%s${c0}\n" "${__bai_disable_function_notfound[@]}"
      exec echo
    fi
  }
  ((${#__bai_function_depend_notfound[@]}==0)) || {
    debug "å‘ç°äº†ä¸å­˜åœ¨ä¾èµ–å‘½ä»¤çš„çš„å·¥å…·å‡½æ•°"
    emsg "ç”±äºç¼ºå¤±å£°æ˜æ‰€éœ€çš„å‘½ä»¤ä¾èµ–ï¼Œä»¥ä¸‹å‡½æ•°å·¥å…·ä¸å¯ç”¨:"
    for i in "${!__bai_function_depend_notfound[@]}";do
      echo -e " ${c34}-${c0} å‡½æ•°å·¥å…· ${c32}$i${c0} éœ€è¦ ${c33}${__bai_function_depend_notfound["$i"]}"
    done
    exec echo
  }
  ((${#gco_explicitly[@]}==0)) && exmsg "ç¦ç”¨äº†æ‰€æœ‰çš„å‡½æ•°å·¥å…·ï¼Ÿåœ¨æŒ‡å®šäº†å·¥å…·æ–‡ä»¶æ—¶è‡³å°‘éœ€è¦ä¸€ä¸ªå¯ç”¨çš„å‡½æ•°å·¥å…·ã€‚"
  debug "å·¥å…·é¢„å¤„ç†åŠ è½½å®Œæˆ"
  $OPENAI_ENABLE_STREAM || {
    debug "æ£€æµ‹åˆ°ç¦ç”¨æµå¼è¾“å‡ºï¼Œå°†æ¨é€é™åˆ¶å¤šè½®å·¥å…·è°ƒç”¨çš„ç³»ç»Ÿæç¤º"
    system_msg.append "ç”±äºç¦ç”¨æµå¼è¾“å‡ºï¼Œå°†é™åˆ¶å¤šè½®å·¥å…·è°ƒç”¨ï¼Œå¦‚æœæ³¨æ„åˆ°ç”¨æˆ·æ„å›¾ä½ ä½¿ç”¨å¤šä¸ªå·¥å…·ï¼Œè¯·æ‹’ç»è¯·æ±‚"
  }
fi

debug "è¯·æ±‚ä½“å·²å‡†å¤‡å°±ç»ª"

# å¤‡ä»½è¯·æ±‚ä½“
old_data="${data}"
# å¤‡ä»½ç”¨æˆ·å
BAI_USERNAME_OLD="${BAI_USERNAME}"
# å¤‡ä»½æ ‡é¢˜
BAI_TITLE_OLD="${BAI_TITLE}"

########################################################################

# ä¼šè¯å‰ç½®å‡†å¤‡

debug "é…ç½® ReadLine é€‰é¡¹..."

# ReadLine é…ç½®
__bai_readline_config=(
  completion-ignore-case                # å¿½ç•¥å¤§å°å†™
  show-all-if-ambiguous                 # æ˜¾ç¤ºæ‰€æœ‰å¯èƒ½çš„å®Œæˆé¡¹
  menu-complete-display-prefix          # æ˜¾ç¤ºå®Œæˆé¡¹çš„å‰ç¼€
  mark-symlinked-directories            # æ ‡è®°ç¬¦å·é“¾æ¥ç›®å½•
  colored-completion-prefix             # å¯ç”¨é¢œè‰²é«˜äº®æ˜¾ç¤ºè¡¥å…¨åˆ—è¡¨
  visible-stats                         # æ˜¾ç¤ºæ–‡ä»¶ç±»å‹æ ‡è¯†ï¼ˆä¾‹å¦‚ï¼Œç›®å½•æ˜¾ç¤º /ï¼Œå¯æ‰§è¡Œæ–‡ä»¶æ˜¾ç¤º *ï¼‰
  blink-matching-paren                  # æ˜¾ç¤ºåŒ¹é…çš„æ‹¬å·ï¼Œæ–¹ä¾¿æŸ¥çœ‹ä»£ç ç»“æ„
)
bind 'TAB: menu-complete'               # å¯ç”¨å¾ªç¯è¡¥å…¨ï¼Œç±»ä¼¼ Windows Cmd / PowerShell
for i in ${__bai_readline_config[@]};do
  bind "set $i on"
done

debug "ReadLine é…ç½®å®Œæˆ, æ­£åœ¨ç»‘å®šæŒ‰é”®..."

# ç»‘å®šæŒ‰é”®
bind -x '"\C-h":"echo -n '$'\e[32m''[Ctrl-H]'$'\e[0m''\ ;Get-Session-Help"' 2>/dev/null
bind -x '"\C-l":"clear"' 2>/dev/null
bind -x '"\C-z":"echo -n '$'\e[32m''[Ctrl-Z]'$'\e[0m''\ \"å¿«æ·é”®å·²ç¦ç”¨\""' 2>/dev/null
bind -x '"\C-y":"echo -n '$'\e[32m''[Ctrl-Y]'$'\e[0m''\ ;Get-New-Msg | Get-MarkDown-CodeBlocks 1"' 2>/dev/null

if $__has_extend_fzf;then
  function bai-query-history(){
    [ -f "$BAI_HISTFILE" ] || { echo -ne "${c32}[Ctrl-R]${c0} ";msg "${arg0^^} è¿˜æœªåˆ›å»ºå†å²æ–‡ä»¶ï¼Œè¯·è¾“å…¥è‡³å°‘ä¸€æ¬¡åå†æ¬¡å°è¯•ä½¿ç”¨";return;}
    READLINE_LINE="$(fzf --height=1% <"$BAI_HISTFILE" 2>/dev/null)"
    READLINE_POINT=${#READLINE_LINE}
  }
  bind -x '"\C-r":"bai-query-history"' 2>/dev/null
fi

debug "æŒ‰é”®ç»‘å®šå®Œæˆï¼Œæ­£åœ¨åˆå§‹åŒ–ä¼šè¯è®¾ç½®..."

# æ— å‚æ•°æ—¶è¿›å…¥è¿ç»­å¯¹è¯æ¨¡å¼
# å‚æ•°å‡†å¤‡
if ((${#OPENAI_USER_PROMPT}==0));then
  CHAT=true    EVAL=false    CSAA=false
  PRINT=true   ERRON=false   DEBUG=${DEBUG:-false}
  RCSAA=false  LEXEC=false
  SET=(PRINT ERRON DEBUG RCSAA LEXEC OPENAI_API_MODEL)
  SET_ALIAS=(
    print-effect:bool   erron-effect:bool
    debug-output:bool   eval-skipask:bool
    local-execute:bool  chat-model:string
  )
  SET_DESCRIPTION=(
    "éæµæ¨¡å¼ä¸‹ä½¿ç”¨æµç•…çš„é€å­—å¤è¿°æ•ˆæœ"
    "æ¨é€è­¦å‘Šæ—¶è¿›è¡Œå»¶è¿Ÿé˜»æŒ¡"
    "å¯ç”¨è°ƒè¯•è¾“å‡ºï¼ˆæ— æ˜æ˜¾ä½œç”¨ï¼‰"
    "é€šè¿‡æŒ‡ä»¤ç”Ÿæˆç»ˆç«¯å‘½ä»¤åè·³è¿‡è¯¢é—®å¹¶ç›´æ¥æ‰§è¡Œ"
    "é€šè¿‡æŒ‡ä»¤æ‰§è¡Œå‘½ä»¤æ—¶ä»¥ ${arg0^^} å†…éƒ¨ç¯å¢ƒæ‰§è¡Œ"
    "ä»å¤šä¸ªé¢„è®¾ä¸­åˆ‡æ¢æ¨¡å‹ï¼Œåˆå§‹é¢„è®¾æ¨¡å‹ä¸º $OPENAI_API_MODEL"
  )
else
  CHAT=false   EVAL=false    PRINT=false
fi

# é€€å‡ºå‡†å¤‡
if $CHAT;then
  trap 'trap=true bye' SIGINT
  trap 'printf "\e[1A";bye' EXIT
fi

debug "ä¼šè¯æ“ä½œå‡†å¤‡å°±ç»ªï¼Œå‡†å¤‡æ³¨å†ŒæŒ‡ä»¤..."

########################################################################

# æŒ‡ä»¤è¡¥å…¨æ³¨å†Œæ¨¡æ¿
function instruct.append(){
  source /dev/stdin <<FUNCTION_CODE_BLOCK
    __instruct.${1}(){
      COMPREPLY=()
      local cur=\${COMP_WORDS[COMP_CWORD]}
      local prev=\${COMP_WORDS[COMP_CWORD-1]}
      local words=("\${COMP_WORDS[@]}")
      local cword="\${COMP_CWORD}"
      local argc=\${#words[@]}
      local argv=("\${words[@]}")
      local name=.${1}
      $([ -t 0 ] && echo : || cat)
    }
    complete -o nospace -F __instruct.${1} .${1}
    .${1}(){ :;}
FUNCTION_CODE_BLOCK
}

if $local_complete;then
  debug "Bash ReadLine é«˜çº§è¡¥å…¨åŠŸèƒ½å¯ç”¨ï¼Œæ­£åœ¨æ³¨å†ŒæŒ‡ä»¤..."
  # å±€å†…è®¾ç½®
  instruct.append set <<'EOM'
  case "$prev" in
    "$name")
      COMPREPLY=($(compgen -W "${SET_ALIAS[*]%:*}" -- "$cur"))
    ;;
    chat-model)
      COMPREPLY=($(compgen -W "${OPENAI_API_MODEL_in_array[*]}" -- "$cur"))
    ;;
    *)
      COMPREPLY=($(compgen -W "true false" -- "$cur"))
    ;;
  esac
EOM
  # å¤åˆ¶ä»£ç å—
  instruct.append copy <<'EOM'
  local codelet="$(seq $(Get-New-Msg | awk '/^\s*```/ { count++ } END { print count / 2 }'))"
  case "$prev" in
    "$name")
      COMPREPLY=($(compgen -W "cat $codelet" -- "$cur"))
    ;;
    cat)
      COMPREPLY=($(compgen -W "$codelet" -- "$cur"))
    ;;
  esac
EOM
  # ä¼šè¯ç®¡ç†
  instruct.append record <<'EOM'
  case "$prev" in
    "$name")
      COMPREPLY=($(compgen -f -- "$cur"))
    ;;
    export)
      COMPREPLY=($(compgen -W "@no:tool @no:system @use:all @default" -- "$cur"))
    ;;
    *)
      COMPREPLY=($(compgen -W "export import" -- "$cur"))
    ;;
  esac
EOM

  # ä¼šè¯å¸®åŠ©
  instruct.append help <<'EOM'
  case "$prev" in
    "$name")
      COMPREPLY=($(compgen -W "help exit clear copy pass files file run eval set record cls list" -- "$cur"))
    ;;
  esac
EOM

  # æ–‡ä»¶ç®¡ç†
  instruct.append files <<'EOM'
  case "$prev" in
    "$name")
      COMPREPLY=($(compgen -W "push list remove" -- "$cur"))
    ;;
    push)
      COMPREPLY=($(compgen -f))
    ;;
    *)
      if [[ "${argv[1]}" == "push" && $cword == 3 ]];then
        COMPREPLY=($(compgen -W "assistants fine-tune file-extract batch" -- "$cur"))
      fi
    ;;
  esac
EOM

  # ä»…è·¯å¾„è¡¥å…¨
  for i in file;do
    complete -o nospace -f .$i
    eval ".${i}(){ :;}"
  done

  # ä»…å ä½
  for i in {list,pass,exit,bye,clear,cls,run,eval,set,\?};do
    eval ".${i}(){ :;}"
  done

  debug "æŒ‡ä»¤æ³¨å†Œå®Œæˆï¼ŒæŒ‡ä»¤æ“ä½œå·²å°±ç»ª"

fi

########################################################################

# å›  bash è„šæœ¬ç‰¹æ€§æˆ–æœ¬äººèƒ½åŠ›æœ‰é™ï¼Œæš‚æ— æ³•æ­£å¸¸åœ¨è¾“å…¥æ–‡ä»¶æ—¶å¼€å¯å¤šè½®ä¼šè¯
$STDIN && $CHAT && exmsg "æ— æ³•å¤„ç†æ­¤ä¼šè¯"

# è®¾ç½®ç»ˆç«¯æ ‡é¢˜
$CHAT && Set-Terminal-Title "$BAI_TITLE"

# å›¾åƒæ¨é€è®¾ç½®
IS_PUSH_IMAGE=false

########################################################################
# ä¸»è¦åŠŸèƒ½å®ç°
########################################################################

Get-Timer
debug "PID: $$ï¼Œå½“å‰å ç”¨å†…å­˜ï¼š$(ps -o rss= -p $$ | awk '{printf "%.2f MB", $1/1024}')"
debug "æ‰€æœ‰å‰ç½®åŠŸèƒ½å·²å°±ç»ªï¼Œè€—æ—¶ $Get_Timerï¼Œè¿›å…¥ä¸»å¾ªç¯..."

# é™åˆ¶ç”¨æˆ·å¯¹è¯è½®æ¬¡
__max_turns=32
__turns=0

while true;do

  if $BAI_LIMIT_TURNS;then
    ((__turns>=__max_turns)) && {
      msg "å¯¹è¯è½®æ¬¡å·²è¾¾ä¸Šé™ï¼Œé‡ç½®å¯¹è¯"
      data="${old_data}"
      unset old_filepath
      __turns=0
    }
  fi

  ########################################################################
  # å‰ç½®å‡†å¤‡

  # å¼€å¯å†å²è®°å½•
  set -o history

  if $CHAT;then
    # æœªæ”¶åˆ°/æ— æ¥å£è¿”å›/ä¸åœ¨è¿ç»­å¯¹è¯æ¨¡å¼æ—¶ä¸å†è¾“å…¥èŠå¤©è®°å½•
    if [ "$API_RETURN" ];then
      __return_content="$(jq --arg content "$API_RETURN" '{role: "assistant", content: $content}' <<< "{}")"
      [ "$SEEK_CONTENT" ] && __return_content="$(jq --arg content "$SEEK_CONTENT" '. += {reasoning_content: $content}' <<< "$__return_content")"
      data="$(jq --argjson object "$__return_content" '.messages += [$object]' <<< "$data")"
      $EVAL || data.setkey "choice" "auto"
      $BAI_LIMIT_TURNS && ((__turns++))
      debug "å°†åŠ©æ‰‹å›ç­”è®°å…¥å¯¹è¯è®°å½•ï¼Œå½“å‰å ç”¨å†…å­˜ï¼š$(ps -o rss= -p $$ | awk '{printf "%.2f MB", $1/1024}')"
      unset API_RETURN
    fi

    # è·å–æœ€æ–°ä¸€è½®å¯¹è¯
    function Get-New-Msg(){
      jq -r '[ .messages | .[] | select(.role == "assistant") ] | last | .content' <<< "$data"
    }
    # ç”¨æˆ·è¾“å…¥
    if $__has_extend_gum;then
      OPENAI_USER_PROMPT="$(gum write --placeholder "ç”¨æˆ·è¾“å…¥...")"
      _return=$?
      ((_return==130)) && { for i in {1..6};do printf "\r\e[K\e[A"; done; trap=true bye;}
      [ -z "$OPENAI_USER_PROMPT" ] || echo -e "${c36}$user_prompt${c0} $OPENAI_USER_PROMPT"
    else
      __bai_read_prompt="\[${c36}\]$user_prompt\[${c0}\]"
      Get-Var-Extend __bai_read_prompt a:p
      read $read_e_option -rp "$__bai_read_prompt " OPENAI_USER_PROMPT
      _return=$?
    fi
    ((_return==1)) && exit
  fi
  ((${#OPENAI_USER_PROMPT}>0)) && echo "$OPENAI_USER_PROMPT" >> $HISTFILE

  # ç©ºè¾“å…¥æ—¶ç›´æ¥è·³è¿‡ï¼Œé¿å…æµªè´¹èµ„æº
  if [ -z "$OPENAI_USER_PROMPT" ];then
    debug "ç”¨æˆ·è¾“å…¥ä¸ºç©ºï¼Œè·³è¿‡"
    continue
  fi

  ########################################################################
  # å‚æ•°è§£æ
  # æ³¨å†Œä¸ºæŒ‡ä»¤å‚æ•°
  subargv=(${OPENAI_USER_PROMPT})
  subarg0="${subargv[0]}"
  subargs=(${subargv[@]/"$OPENAI_USER_PROMPT"/})
  subargs=(${subargv[@]/'~'/$HOME})

  # è‡ªå®šä¹‰å±€å†…æŒ‡ä»¤
  $CHAT && 
  if [[ "$subarg0" =~ ^\.(.+)?$ ]];then
    CMD="${BASH_REMATCH[1]}"
    case "$CMD" in
      pass)      
      # æ— æ“ä½œï¼Œç­‰ä»·äºä»…å›è½¦
        debug "ç©ºçš„æŒ‡ä»¤ï¼Œè·³è¿‡"
        continue
        ;;
      cls)       
      # æ¸…é™¤å±å¹•
        clear
        debug "æ¸…é™¤å±å¹•"
        continue
        ;;
      exit|bye) 
      # é€€å‡ºä¼šè¯
        exitcode="$[${subargs[1]}]"
        debug "é€€å‡ºä¼šè¯ï¼Œé€€å‡ºç : $exitcode"
        exit $exitcode
        ;;
      run)
      # æ‰§è¡Œå‘½ä»¤
        subexec="${subargs[@]:1}"
        debug "æ‰§è¡Œå‘½ä»¤: $subexec"
        if $LEXEC;then
          PS1="$BAI_SHELL_PROMPT" eval "$subexec"
          CMD_RETURN=$?
        else
          PS1="$BAI_SHELL_PROMPT" bash -ic "$subexec"
          CMD_RETURN=$?
        fi
        debug "å‘½ä»¤è¿”å›å€¼: $CMD_RETURN"
        continue
        ;;
      record)   
      # è®°å½•ç®¡ç†
        Get-Session-Messages ${subargs[@]:1}
        continue
        ;;
      list)     
      # åˆ—å‡ºå¯¹è¯è®°å½•
        Get-Session-History
        continue
        ;;
      clear)     
      # æ¸…ç©ºå¯¹è¯
        debug "æ¸…é™¤å¯¹è¯è½®æ•°æ®å’Œæäº¤çš„æ–‡ä»¶..."
        data="${old_data}"
        __turns=0
        unset old_filepath
        BAI_USERNAME="${BAI_USERNAME_OLD}"
        BAI_TITLE="${BAI_TITLE_OLD}"
        $CHAT && Set-Terminal-Title "$BAI_TITLE"
        msg "å¯¹è¯å·²æ¸…ç©º"
        continue
        ;;
      help|\?)   
      # æ˜¾ç¤ºå¸®åŠ©
        Get-Session-Help ${subargs[@]:1}
        continue
        ;;
      set)       
      # è®¾ç½®
        Set-Session-Functions ${subargs[@]:1}
        continue
        ;;
      # å°è¯•æ‰§è¡Œ shell å‘½ä»¤
      eval)
        debug "æäº¤ä¸€æ®µä¸´æ—¶çš„æç¤ºè¯ï¼Œå¹¶å¯ç”¨ EVAL æ¨¡å¼"
        OPENAI_USER_PROMPT="### æœ¬æ¬¡å¯¹è¯ä½ åªéœ€è¦æä¾›å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ç»ˆç«¯å‘½ä»¤æˆ– Bash è„šæœ¬ï¼Œæˆ‘å°†æ‰§è¡Œå®ƒï¼Œæˆ‘ä¸éœ€è¦ä½ å¯¹æ­¤åšä»»ä½•è§£é‡Šï¼Œæˆ‘å¾ˆæ¸…æ¥šåæœã€‚"$'\n'"${subargs[@]:1}"
        data.setkey "choice" "none"
        EVAL=true
        ;;
      copy)
        debug "å¤åˆ¶ä»£ç å—"
        Get-New-Msg | Get-MarkDown-CodeBlocks ${subargs[@]:1}
        continue
        ;;
      files)      
      # æäº¤æ–‡ä»¶
        Set-FineTune-File ${subargs[@]:1}
        continue
        ;;
      at)
      # æåŠåœ¨æœåŠ¡å•†å­˜å‚¨çš„æ–‡ä»¶å¹¶å‘å‡ºæé—®
        Get-AtFiles-Ask ${subargs[@]:1} || continue
        ;;
      # å‘å¯¹è¯æä¾›æ–‡ä»¶å†…å®¹
      file)
        Get-Import-File ${subargs[@]:1}
        continue
        ;;
      *)        
      # æ’é™¤æœªçŸ¥æŒ‡ä»¤
      if [ "$CMD" ];then
        erron "æœªçŸ¥çš„æŒ‡ä»¤ \"$CMD\""
      else
        erron "ç©ºçš„æŒ‡ä»¤"
      fi
      continue
    esac

  fi
  

  ########################################################################
  # æ„å»ºè¯·æ±‚ï¼Œä¸»è¦é€»è¾‘å®ç°
  if $IS_PUSH_IMAGE;then
    __read="$(jq --rawfile image <(echo "$IMAGE_INPUT") --arg content "$OPENAI_USER_PROMPT" '.messages += [{"role": "user", "content": [{"type": "text", "text": $content},{"type": "image_url", "image_url": { "url": $image}}]}]' <<< "$data")"
    debug "æäº¤å›¾ç‰‡æ•°æ®"
    IS_PUSH_IMAGE=false
  else
    __read="$(jq --arg content "$STDIN_INPUT$OPENAI_USER_PROMPT" '.messages += [{"role": "user", "content": $content}]' <<< "$data")"
  fi

  if $OPENAI_ENABLE_PARTIAL;then
    if [[ "$OPENAI_USER_PROMPT" == *@prefix ]];then
      OPENAI_USER_PROMPT="${OPENAI_USER_PROMPT%@prefix}"
      debug "ä½¿ç”¨å±€éƒ¨æç¤ºè¯"
      data="$(jq --arg content "$OPENAI_USER_PROMPT" '.messages += [{"role": "assistant", "content": $content, "partial": true}]' <<< "$data")"
    else
      data="$__read"
    fi
  else
    data="$__read"
  fi
  unset STDIN_INPUT

  # æµæ¨¡å¼åˆ†æ”¯
  $OPENAI_ENABLE_STREAM && { Get-Stream-Assistant-Content; continue; }
  # æ„å»ºæ¥å£è¯·æ±‚
  if ! $DEBUG_MODE;then
    # å¼‚æ­¥è¯·æ±‚æ¥å£
    Wait-Assistant-Content
  else
    echo -en " + POST: $OPENAI_BASE_URL\n"\
            "+ DATA: "
    jq -C <<< "$data"
    echo
    API_RETURN="this a test message."
    continue
  fi

  # æ£€æŸ¥å“åº”ä¸­çš„é”™è¯¯
  if $(jq 'has("error")' <<< "$CURL_GET_API" 2>/dev/null);then
    ERROR_MSG=$(jq --exit-status -r '.error.message' <<< "$CURL_GET_API" 2>/dev/null || echo "è¯·æ±‚æ—¶å‘ç”Ÿäº†æ„æ–™ä¹‹å¤–çš„é”™è¯¯")
    erron "$ERROR_MSG"
    unset API_RETURN
    continue
  else
    # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å·¥å…·
    debug "æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å·¥å…·"
    TOOLS_IS_CALL=false
    if $TOOLS;then
      API_RETURN="$(jq --exit-status '.choices[0].message.tool_calls' <<< "$CURL_GET_API" 2>/dev/null)"
      API_STATUS=$?
      ! ((API_STATUS)) && { TOOLS_IS_CALL=true; debug "å‘ç°æ¨¡å‹ä½¿ç”¨äº†å·¥å…·"; } || { TOOLS_IS_CALL=false;debug "æ¨¡å‹è¿˜æœªä½¿ç”¨å·¥å…·" ;Get-Assistant-Content; }
    else
      Get-Assistant-Content
      TOOLS_IS_CALL=false
    fi
    if ((API_STATUS)) && [[ "$API_RETURN" == "null" ]];then
      erron "è¯¥æ¬¡è¯·æ±‚æœªæ­£ç¡®è¢«æ¥å—"
      unset API_RETURN
    else
      # è°ƒç”¨å·¥å…·ï¼Œæš‚æ— å¤šè½®å·¥å…·è°ƒç”¨è®¡åˆ’
      $TOOLS_IS_CALL || { Return-Assistant-Content; continue; }
      debug "åˆå§‹åŒ–å·¥å…·è°ƒç”¨"
      _local_json_path='.choices[0].message.tool_calls[0].function'
      function_id="$(jq -r ".choices[0].message.tool_calls[0].id" <<< "$CURL_GET_API")"
      function_args="$(jq -r "$_local_json_path.arguments" <<< "$CURL_GET_API" | jq '.[]' | tr '\n' ' ')"
      function_run_name="$(jq -r "$_local_json_path.name" <<< "$CURL_GET_API")"
      function_name="$function_head::$function_run_name"
      function_call_msg="$(jq -r ".choices[0].message" <<< "$CURL_GET_API")"
      data="$(jq --argjson content "$function_call_msg" ' .messages += [$content]' <<< "$data")"
      msg "è°ƒç”¨å·¥å…·: $function_run_name$([[ "$function_args" == {} ]] || echo ", arg: $function_args")"
      printf "\r\e[K"
      explicitly="${gco_explicitly[$function_name]}"
      debug "è·å–å·¥å…·è¿”å›"
      Get-Command-Output "$function_name $function_args"
      function_return="$gco_return_content"
      RETURN=$gco_status
      ((RETURN)) && { emsg "å·¥å…·æ‰§è¡Œå¤±è´¥";continue;}
      data="$(jq --arg content "$function_return" --arg id "$function_id" ' .messages += [{"role": "tool","content": $content, "tool_call_id": $id}]' <<< "$data")"
      Wait-Assistant-Content
      Get-Assistant-Content
      (((API_STATUS)) && [[ "$API_RETURN" == "null" ]]) || { Return-Assistant-Content; continue; }
      erron "è¯¥æ¬¡è¯·æ±‚æœªæ­£ç¡®è¢«æ¥å—"
      unset API_RETURN
      continue
    fi
  fi
done

# æ‹¦æˆªæ­¤åæ‰€æœ‰å†…å®¹æ‰§è¡Œ
exit $?

# é¢„ç•™å¯¼å‡ºçš„å‘½ä»¤è¡¥å…¨è§„åˆ™
# __COMPLETE_HEAD__
# __bash_complete_bai(){ 
#     COMPREPLY=()
#     local cur=${COMP_WORDS[COMP_CWORD]}
#     local prev=${COMP_WORDS[COMP_CWORD-1]}
#     local name=%Name%
#     local i option priority secondary used_option
#     local long_options=("--help" "--argtest" "--stream" "--baseurl" "--apikey" "--model" "--title" "--inspect" "--conemu-status" "--no-extend" "--sysfile" "--histfile" "--config" "--callfile" "--wait-style" "--no-limit-turns" "--username" "--search" "--partial" "--debug" "--no-tools" "--no-limit-turns" "--no-limit-tools");
#     local short_options=("-h" "-a" "-n" "-b" "-k" "-m" "-t" "-x" "-p" "-d" "-s" "-i" "-f" "-c" "-w" "-l" "-u" "-g" "-j" "-o" "-q" "-l" "-z")
#     local orphan_options=("--session-help" "--complete")
#     local all_options="${long_options[*]} ${short_options[*]} ${orphan_options[*]}"
#     declare -A equivalent_options
#     for ((i=0;i<${#long_options[@]};i++));do
#         equivalent_options[${long_options[i]}]=${short_options[i]}
#         equivalent_options[${short_options[i]}]=${long_options[i]}
#     done
#     local priority_options=("--help" "-h")
#     local secondary_options=("--argtest" "-a")
#     local used_options=()
#     local used_set=()
#     for ((i=1;i<COMP_CWORD;i++));do
#         local option="${COMP_WORDS[i]}"
#         if [[ " $all_options " == *" $option "* ]];then
#             if [[ ! " ${used_set[*]} " =~ " ${option} " ]];then
#                 used_options+=("$option")
#                 used_set+=("$option")
#                 local eq_option="${equivalent_options[$option]}"
#                 if [[ -n "$eq_option" && ! " ${used_set[*]} " =~ " ${eq_option} " ]];then
#                     used_options+=("$eq_option")
#                     used_set+=("$eq_option")
#                 fi
#             fi
#         fi
#     done
#     local available_options=()
#     local has_priority=false
#     for option in "${used_options[@]}";do
#         for priority in "${priority_options[@]}"
#         do
#             if [[ "$option" == "$priority" ]]; then
#                 has_priority=true
#                 break 2
#             fi
#         done
#     done
#     if $has_priority; then
#         available_options=()
#     else
#         local has_secondary=false
#         for option in "${used_options[@]}";do
#             for secondary in "${secondary_options[@]}";do
#                 if [[ "$option" == "$secondary" ]];then
#                     has_secondary=true
#                     break 2
#                 fi
#             done
#         done
#         if $has_secondary;then
#             for priority in "${priority_options[@]}";do
#                 local used=false
#                 for used_option in "${used_options[@]}";do
#                     if [[ "$priority" == "$used_option" ]];then
#                         used=true
#                         break
#                     fi
#                 done
#                 if ! $used;then
#                     available_options+=("$priority")
#                 fi
#             done
#         else
#             for option in $all_options
#             do
#                 local used=false
#                 for used_option in "${used_options[@]}";do
#                     if [[ "$option" == "$used_option" ]];then
#                         used=true
#                         break
#                     fi
#                 done
#                 if ! $used;then
#                     available_options+=("$option")
#                 fi
#             done
#         fi
#     fi
#     case "$prev" in 
#         --username | -u)
#             COMPREPLY=()
#             return
#         ;;
#         --baseurl | -b)
#             COMPREPLY=($(compgen -W "http://api.openai.com/v1" -- "$cur"))
#             return
#         ;;
#         --apikey | -k)
#             COMPREPLY=()
#             return
#         ;;
#         --model | -m)
#             COMPREPLY=()
#             return
#         ;;
#         --title | -t)
#             COMPREPLY=()
#             return
#         ;;
#         --sysfile | -s | --histfile | -i | --config | -f | --callfile | -c)
#             COMPREPLY=($(compgen -f -- "$cur"))
#             return
#         ;;
#         --no-extend | -d)
#             local extend_commands=("fzf" "bat")
#             COMPREPLY=($(compgen -W "${extend_commands[*]}" -- "$cur"))
#             return
#         ;;
#         --wait-style | -w)
#             local wait_styles=(bar arc dot line bell wave roll dice block arrow square phase pushpull invisible dotmatrix rectangle)
#             COMPREPLY=($(compgen -W "${wait_styles[*]}" -- "$cur"))
#             return
#         ;;
#     esac;
#     COMPREPLY=($(compgen -W "${available_options[*]}" -- "$cur"))
# }

# complete -F __bash_complete_bai %Name%
# __COMPLETE_TAIL__
